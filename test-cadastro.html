<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste de Cadastro - Natan General Service</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #4f46e5;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            background: #f9fafb;
            border-left: 4px solid #4f46e5;
        }
        button {
            background: #4f46e5;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        button:hover {
            background: #4338ca;
        }
        #output {
            background: #1f2937;
            color: #10b981;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 20px;
        }
        .error { color: #ef4444; }
        .success { color: #10b981; }
        .warning { color: #f59e0b; }
        .info { color: #3b82f6; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Teste de Cadastro - Natan General Service</h1>
        
        <div class="test-section">
            <h2>Teste 1: Conex√£o com Supabase</h2>
            <p>Verifica se o Supabase est√° acess√≠vel</p>
            <button onclick="testConnection()">Testar Conex√£o</button>
        </div>

        <div class="test-section">
            <h2>Teste 2: Envio de E-mail (OTP)</h2>
            <p>Testa o envio de c√≥digo de verifica√ß√£o</p>
            <input type="email" id="testEmail" placeholder="seu-email@exemplo.com" style="padding: 8px; margin-right: 10px; width: 250px;">
            <button onclick="testEmailSend()">Enviar C√≥digo de Teste</button>
        </div>

        <div class="test-section">
            <h2>Teste 3: Verificar Usu√°rios Existentes</h2>
            <p>Lista os usu√°rios criados recentemente</p>
            <button onclick="listRecentUsers()">Listar Usu√°rios</button>
        </div>

        <div class="test-section">
            <h2>Teste 4: Limpar Dados de Teste</h2>
            <p>Remove usu√°rios de teste criados</p>
            <button onclick="clearTestData()">Limpar Testes</button>
        </div>

        <div id="output"></div>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

        const supabaseUrl = 'https://uqrvenlkquheajuveggv.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVxcnZlbmxrcXVoZWFqdXZlZ2d2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwNzg4NDgsImV4cCI6MjA3MjY1NDg0OH0.ZdgBkvjC5irHh7E9fagqX_Pu797anPfE8jO91iNDRIc';

        window.supabase = createClient(supabaseUrl, supabaseKey);

        function log(message, type = 'info') {
            const output = document.getElementById('output');
            const timestamp = new Date().toLocaleTimeString();
            const className = type;
            output.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            output.scrollTop = output.scrollHeight;
        }

        window.testConnection = async function() {
            log('üîç Testando conex√£o com Supabase...', 'info');
            
            try {
                const response = await fetch(supabaseUrl + '/rest/v1/');
                if (response.ok) {
                    log('‚úÖ Supabase est√° acess√≠vel! Status: ' + response.status, 'success');
                } else {
                    log('‚ö†Ô∏è Resposta inesperada: ' + response.status, 'warning');
                }
            } catch (error) {
                log('‚ùå Erro de conex√£o: ' + error.message, 'error');
            }
        };

        window.testEmailSend = async function() {
            const emailInput = document.getElementById('testEmail');
            const email = emailInput.value.trim();

            if (!email) {
                log('‚ùå Por favor, digite um e-mail', 'error');
                return;
            }

            log('üìß Enviando c√≥digo para: ' + email, 'info');

            try {
                const { data, error } = await window.supabase.auth.signInWithOtp({
                    email: email,
                    options: {
                        shouldCreateUser: true,
                        data: {
                            name: 'Teste via HTML',
                            role: 'professional'
                        }
                    }
                });

                if (error) {
                    log('‚ùå Erro ao enviar: ' + error.message, 'error');
                    
                    if (error.message.includes('rate limit')) {
                        log('‚ö†Ô∏è Rate limit atingido. Aguarde 5 minutos', 'warning');
                    }
                } else {
                    log('‚úÖ E-mail enviado com sucesso!', 'success');
                    log('üìä Session criada: ' + !!data.session, 'info');
                    log('üìä Email confirmado: ' + !!data.user?.email_confirmed_at, 'info');
                    
                    if (!data.session && !data.user?.email_confirmed_at) {
                        log('‚úÖ Configura√ß√£o correta: confirma√ß√£o de e-mail habilitada', 'success');
                        log('üì¨ Verifique sua caixa de entrada e spam', 'info');
                    } else {
                        log('‚ö†Ô∏è Aten√ß√£o: Auto-confirma√ß√£o pode estar ativa', 'warning');
                    }
                }

                // Limpar sess√£o
                await window.supabase.auth.signOut();
            } catch (error) {
                log('‚ùå Erro inesperado: ' + error.message, 'error');
            }
        };

        window.listRecentUsers = async function() {
            log('üìã Buscando usu√°rios recentes...', 'info');

            try {
                const { data: { user } } = await window.supabase.auth.getUser();
                
                if (user) {
                    log('‚ö†Ô∏è H√° uma sess√£o ativa. Fazendo logout primeiro...', 'warning');
                    await window.supabase.auth.signOut();
                }

                // N√£o podemos listar usu√°rios diretamente via auth.admin sem service_role_key
                // Mas podemos verificar a tabela users se tivermos RLS configurado
                log('‚ÑπÔ∏è Para listar usu√°rios, acesse o dashboard do Supabase:', 'info');
                log('   https://supabase.com/dashboard/project/uqrvenlkquheajuveggv/auth/users', 'info');
                
            } catch (error) {
                log('‚ùå Erro: ' + error.message, 'error');
            }
        };

        window.clearTestData = async function() {
            log('üóëÔ∏è Para limpar dados de teste:', 'info');
            log('   1. Acesse: https://supabase.com/dashboard/project/uqrvenlkquheajuveggv/auth/users', 'info');
            log('   2. Filtre por e-mails de teste', 'info');
            log('   3. Delete manualmente os usu√°rios de teste', 'info');
            log('‚ö†Ô∏è N√£o √© poss√≠vel deletar usu√°rios via anon key por seguran√ßa', 'warning');
        };

        // Log inicial
        log('üöÄ Ferramenta de teste carregada', 'success');
        log('üìù Use os bot√µes acima para testar cada funcionalidade', 'info');
    </script>
</body>
</html>
