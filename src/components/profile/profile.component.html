<div
  class="flex items-center justify-center min-h-screen bg-gradient-to-br from-indigo-100 via-white to-indigo-300 mobile-safe"
>
  <div
    class="w-full max-w-2xl p-4 md:p-8 space-y-8 bg-white/90 backdrop-blur-md rounded-3xl shadow-2xl relative border border-indigo-100 transition-all duration-300"
  >
    <!-- Seletor de idioma no topo direito -->
    <div class="absolute top-3 right-3 flex items-center gap-2 z-10">
      <i class="fas fa-globe text-indigo-500 text-lg"></i>
      <select
        class="px-2 py-1 rounded-lg border border-indigo-200 bg-indigo-50 text-indigo-700 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-400"
        (change)="i18n.setLanguage($event.target.value)"
        [value]="i18n.language()"
        aria-label="Selecionar idioma"
      >
        <option value="pt">PortuguÃªs</option>
        <option value="en">English</option>
      </select>
    </div>
    <div class="flex flex-col items-center pt-8 pb-2 gap-2">
      <div class="relative group h-24 w-24 md:h-32 md:w-32 mb-2">
        <img
          class="h-24 w-24 md:h-32 md:w-32 rounded-full object-cover shadow-lg"
          [src]="user().avatar_url"
          [alt]="user().name"
        />
        <div
          class="absolute inset-0 bg-black bg-opacity-50 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity cursor-pointer"
        >
          <div class="flex space-x-6">
            <button
              (click)="fileInput.click()"
              [title]="'uploadPhoto' | i18n"
              class="text-white text-2xl md:text-3xl hover:text-gray-300"
            >
              <i class="fas fa-upload"></i>
            </button>
            <button
              (click)="openCameraModal()"
              [title]="'useCamera' | i18n"
              class="text-white text-2xl md:text-3xl hover:text-gray-300"
            >
              <i class="fas fa-camera"></i>
            </button>
          </div>
        </div>
      </div>
      <input
        type="file"
        #fileInput
        hidden
        (change)="onFileSelected($event)"
        accept="image/png, image/jpeg, image/gif"
      />
      <h2
        class="text-2xl md:text-3xl font-extrabold text-indigo-700 drop-shadow-sm mt-2"
      >
        {{ user().name }}
      </h2>
      <p class="text-base text-indigo-400 font-medium mb-2 capitalize">
        {{ user().role }}
      </p>
    </div>
    <form
      #profileForm="ngForm"
      (ngSubmit)="saveProfile()"
      class="space-y-7 bg-white/95 shadow-xl rounded-2xl px-6 py-8"
    >
      <div class="space-y-6">
        <div>
          <label
            for="name"
            class="block text-sm font-semibold text-indigo-700 mb-1"
            >{{ "fullName" | i18n }}</label
          >
          <input
            type="text"
            id="name"
            name="name"
            [ngModel]="name()"
            (ngModelChange)="name.set($event); checkIfChanged()"
            required
            class="w-full px-4 py-2 border border-indigo-200 rounded-lg shadow-sm placeholder-indigo-300 focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:border-indigo-400 transition-all duration-150 bg-indigo-50/40"
          />
        </div>
        <div>
          <label
            for="phone"
            class="block text-sm font-semibold text-indigo-700 mb-1"
            >{{ "phoneNumber" | i18n }}</label
          >
          <input
            type="tel"
            id="phone"
            name="phone"
            [ngModel]="phone()"
            (ngModelChange)="phone.set($event); checkIfChanged()"
            pattern="^\+[1-9]{1}[0-9]{1,2} ?[0-9]{3,}([ \-]?[0-9]{2,}){1,}$"
            class="w-full px-4 py-2 border border-indigo-200 rounded-lg shadow-sm placeholder-indigo-300 focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:border-indigo-400 transition-all duration-150 bg-indigo-50/40"
            placeholder="+351 912 345 678"
          />
          <div
            *ngIf="
              profileForm.controls.phone?.invalid &&
              profileForm.controls.phone?.dirty
            "
            class="text-red-500 text-xs mt-1"
          >
            {{ "phoneFormatError" | i18n }}
          </div>
        </div>
        <div>
          <label
            for="email"
            class="block text-sm font-semibold text-indigo-700 mb-1"
            >{{ "emailAddress" | i18n }}</label
          >
          <input
            type="email"
            id="email"
            name="email"
            [ngModel]="email()"
            (ngModelChange)="email.set($event); checkIfChanged()"
            required
            email
            class="w-full px-4 py-2 border border-indigo-200 rounded-lg shadow-sm placeholder-indigo-300 focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:border-indigo-400 transition-all duration-150 bg-indigo-50/40"
          />
        </div>
        @if (user().role === 'professional') {
        <div>
          <fieldset>
            <legend class="block text-sm font-semibold text-indigo-700 mb-2">
              {{ "mySpecialties" | i18n }}
            </legend>
            <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
              @for (cat of allCategories(); track cat) {
              <div class="flex items-start">
                <div class="flex items-center h-5">
                  <input
                    [id]="'specialty-' + cat"
                    type="checkbox"
                    [checked]="isSpecialtyChecked(cat)"
                    (change)="onSpecialtyChange(cat, $event)"
                    class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300 rounded"
                  />
                </div>
                <div class="ml-2 text-sm">
                  <label
                    [for]="'specialty-' + cat"
                    class="font-medium text-gray-700"
                    >{{ cat }}</label
                  >
                </div>
              </div>
              }
            </div>
          </fieldset>
        </div>
        }
      </div>
      <div
        class="flex flex-col sm:flex-row sm:justify-end gap-4 pt-6 border-t border-gray-200"
      >
        <button
          type="button"
          (click)="goToDashboard()"
          class="w-full sm:w-auto inline-flex justify-center items-center px-6 py-3 border border-gray-300 text-base font-medium rounded-lg text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors duration-200"
        >
          {{ "cancel" | i18n }}
        </button>
        <button
          type="submit"
          [disabled]="profileForm.invalid || !isChanged()"
          class="w-full sm:w-auto inline-flex justify-center items-center px-6 py-3 border border-transparent text-base font-bold rounded-lg text-white bg-gradient-to-r from-indigo-500 via-indigo-600 to-indigo-700 hover:from-indigo-600 hover:to-indigo-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:bg-indigo-300 disabled:cursor-not-allowed transition-colors duration-200 shadow-md"
        >
          {{ "saveChanges" | i18n }}
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Camera Modal -->
@if (showCameraModal()) {
<div
  class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50"
  (click)="closeCameraModal()"
>
  <div
    class="bg-white p-6 rounded-lg shadow-xl text-center max-w-2xl w-full mx-4"
    (click)="$event.stopPropagation()"
  >
    <h3 class="text-xl font-semibold mb-4">{{ "capturePhoto" | i18n }}</h3>

    <!-- Video container with loading state -->
    <div class="relative rounded-md overflow-hidden bg-gray-900 mb-4">
      <video
        #videoElement
        autoplay
        playsinline
        muted
        class="w-full h-auto max-h-96 bg-gray-900"
        [style.display]="'block'"
      ></video>

      <!-- Loading overlay -->
      <div
        class="absolute inset-0 bg-gray-900 flex items-center justify-center"
        [style.display]="'none'"
        id="videoLoading"
      >
        <div class="text-white">
          <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
          <p>{{ "loadingCamera" | i18n }}</p>
        </div>
      </div>
    </div>

    <!-- Action buttons -->
    <div class="flex justify-center space-x-4">
      <button
        (click)="capturePhoto()"
        class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 flex items-center space-x-2 transition-colors"
      >
        <i class="fas fa-camera"></i>
        <span>{{ "capture" | i18n }}</span>
      </button>
      <button
        (click)="closeCameraModal()"
        class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-500 transition-colors"
      >
        {{ "cancel" | i18n }}
      </button>
    </div>

    <!-- Instructions -->
    <p class="text-sm text-gray-600 mt-4">
      {{ "cameraInstructions" | i18n }}
    </p>
  </div>
</div>
}

<!-- Save Toast Notification -->
@if (showSaveToast()) {
<div class="fixed top-4 right-4 z-50 max-w-sm w-full">
  <div
    class="p-4 rounded-lg shadow-lg border-l-4 transition-all duration-300 transform translate-x-0"
    [class]="
      saveToastType() === 'success'
        ? 'bg-green-50 border-green-400 text-green-800'
        : 'bg-red-50 border-red-400 text-red-800'
    "
  >
    <div class="flex items-center">
      <div class="flex-shrink-0">
        @if (saveToastType() === 'success') {
        <i class="fas fa-check-circle text-green-500 text-xl"></i>
        } @else {
        <i class="fas fa-exclamation-circle text-red-500 text-xl"></i>
        }
      </div>
      <div class="ml-3">
        <p class="text-sm font-medium">{{ saveToastMessage() }}</p>
      </div>
      <div class="ml-auto pl-3">
        <button
          (click)="showSaveToast.set(false)"
          class="text-gray-400 hover:text-gray-600 focus:outline-none"
        >
          <i class="fas fa-times"></i>
        </button>
      </div>
    </div>
  </div>
</div>
}
