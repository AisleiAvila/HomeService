<div
  class="flex flex-col items-center justify-center relative group h-24 w-full md:h-32 md:w-full mb-2 mobile-safe"
>
  <img
    class="h-24 w-24 md:h-32 md:w-32 rounded-full object-cover shadow-lg"
    [src]="user().avatar_url"
    [alt]="user().name"
  />
  <div
    class="absolute inset-0 bg-black bg-opacity-50 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity cursor-pointer"
  >
    <div class="flex space-x-6">
      <button
        (click)="fileInput.click()"
        [title]="'uploadPhoto' | i18n"
        class="text-white text-2xl md:text-3xl hover:text-gray-300"
      >
        <i class="fas fa-upload"></i>
      </button>
      <button
        (click)="openCameraModal()"
        [title]="'useCamera' | i18n"
        class="text-white text-2xl md:text-3xl hover:text-gray-300"
      >
        <i class="fas fa-camera"></i>
      </button>
    </div>
  </div>
  <input
    type="file"
    #fileInput
    hidden
    (change)="onFileSelected($event)"
    accept="image/png, image/jpeg, image/gif"
  />
  <h2
    class="text-2xl md:text-3xl font-extrabold text-indigo-700 drop-shadow-sm mt-2 text-center whitespace-nowrap"
  >
    {{ user().name }}
  </h2>
  <p class="text-base text-indigo-400 font-medium mb-2 capitalize text-center">
    {{ user().role | i18n }}
  </p>
</div>
<form
  #profileForm="ngForm"
  (ngSubmit)="saveProfile()"
  class="space-y-7 bg-white/95 shadow-xl rounded-2xl px-0 md:px-12 py-8 background-color='bg-red'"
>
  <!-- Card: Dados Pessoais -->
  <div
    class="rounded-xl border border-indigo-100 bg-white/80 shadow-sm p-4 md:p-6 mb-4 flex flex-col gap-4 w-full mobile-safe"
  >
    <h3 class="text-lg font-bold text-indigo-700 mb-2">
      {{ "personalData" | i18n }}
    </h3>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-8">
      <div class="w-full">
        <label
          for="name"
          class="block text-sm font-semibold text-indigo-700 mb-1"
          >{{ "fullName" | i18n }}</label
        >
        <input
          type="text"
          id="name"
          name="name"
          [ngModel]="name()"
          (ngModelChange)="name.set($event); checkIfChanged()"
          required
          class="w-full px-4 py-2 border border-indigo-200 rounded-lg shadow-sm placeholder-indigo-300 focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:border-indigo-400 transition-all duration-150 bg-indigo-50/40"
        />
      </div>
    </div>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-8">
      <div class="w-full">
        <label
          for="email"
          class="block text-sm font-semibold text-indigo-700 mb-1"
          >{{ "emailAddress" | i18n }}</label
        >
        <input
          type="email"
          id="email"
          name="email"
          [ngModel]="email()"
          (ngModelChange)="email.set($event); checkIfChanged()"
          required
          class="w-full px-4 py-2 border border-indigo-200 rounded-lg shadow-sm placeholder-indigo-300 focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:border-indigo-400 transition-all duration-150 bg-indigo-50/40"
        />
      </div>
    </div>
  </div>

  <!-- Card: Contato e Preferências -->
  <div
    class="rounded-xl border border-indigo-100 bg-white/80 shadow-sm p-4 md:p-6 mb-4 flex flex-col gap-4 w-full mobile-safe"
  >
    <h3 class="text-lg font-bold text-indigo-700 mb-4">
      {{ "contactPreferences" | i18n }}
    </h3>
    <div class="flex flex-col gap-6">
      <div class="flex flex-col md:flex-row items-center gap-4 w-full">
        <div class="flex flex-row items-center w-full gap-1">
          <div class="flex-1 w-full">
            <label
              for="phone"
              class="block text-sm font-semibold text-indigo-700 mb-1"
              >{{ "phoneNumber" | i18n }}</label
            >
            <input
              type="tel"
              id="phone"
              name="phone"
              [ngModel]="phone()"
              (ngModelChange)="phone.set($event); checkIfChanged()"
              pattern="^\+[1-9]{1}[0-9]{1,2} ?[0-9]{3,}([ \-]?[0-9]{2,}){1,}$"
              class="w-full md:w-48 max-w-full px-4 py-2 border border-indigo-200 rounded-lg shadow-sm placeholder-indigo-300 focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:border-indigo-400 transition-all duration-150 bg-indigo-50/40"
              [placeholder]="'phonePlaceholder' | i18n"
            />
          </div>
          <div class="flex-1 w-full">
            <ng-container
              *ngIf="
                user().phone != null &&
                user().phone.trim() !== '' &&
                !user().phone_verified
              "
            >
              <div class="flex justify-end w-full md:w-64">
                <button
                  type="button"
                  (click)="sendSmsVerification()"
                  class="w-full px-6 py-2 bg-indigo-500 text-white rounded-lg font-semibold hover:bg-indigo-600 transition whitespace-nowrap"
                >
                  {{ "sendVerificationCode" | i18n }}
                </button>
              </div>
            </ng-container>
          </div>
        </div>
      </div>
      <div class="flex items-center gap-3">
        <input
          type="checkbox"
          name="receiveSmsNotifications"
          [(ngModel)]="receiveSmsNotifications"
          class="form-checkbox h-4 w-4 text-indigo-600"
        />
        <span class="text-sm text-indigo-700 font-semibold">{{
          "receiveSmsNotifications" | i18n
        }}</span>
      </div>
      <div
        *ngIf="
          profileForm.controls.phone?.invalid &&
          profileForm.controls.phone?.dirty
        "
        class="text-red-500 text-xs mt-1"
      >
        {{ "phoneFormatError" | i18n }}
      </div>
      <span *ngIf="smsSent" class="text-green-600 text-xs mt-1">{{
        "smsSentInfo" | i18n
      }}</span>
      <div
        *ngIf="!user().phone_verified && user().sms_code"
        class="flex flex-col md:flex-row md:items-center gap-3 mt-2"
      >
        <label
          for="smsCode"
          class="block text-sm font-semibold text-indigo-700 mb-1"
          >{{ "smsCodeLabel" | i18n }}</label
        >
        <input
          type="text"
          id="smsCode"
          name="smsCode"
          [(ngModel)]="smsCode"
          maxlength="6"
          class="w-full md:w-32 px-2 py-1 border border-indigo-200 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-400"
          [placeholder]="'smsCodePlaceholder' | i18n"
        />
        <button
          type="button"
          (click)="validateSmsCode()"
          class="w-full md:w-40 px-4 py-2 bg-green-500 text-white rounded-lg font-semibold hover:bg-green-600 transition"
        >
          {{ "validateCode" | i18n }}
        </button>
        <span *ngIf="smsValid === true" class="text-green-600 text-xs ml-2">{{
          "smsCodeValid" | i18n
        }}</span>
        <div *ngIf="lastNotification()" class="text-red-500 text-xs mt-2">
          {{ lastNotification() }}
        </div>
      </div>
    </div>
  </div>

  <!-- Card: Especialidades -->
  <ng-container *ngIf="user().role === 'professional'">
    <div
      class="rounded-xl border border-indigo-100 bg-white/80 shadow-sm p-4 md:p-6 mb-4 flex flex-col gap-4 w-full"
    >
      <h3 class="text-lg font-bold text-indigo-700 mb-2">
        {{ "mySpecialties" | i18n }}
      </h3>
      <fieldset>
        <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
          <ng-container *ngFor="let cat of allCategories()">
            <div class="flex items-start w-full">
              <div class="flex items-center h-5">
                <input
                  [id]="'specialty-' + cat"
                  type="checkbox"
                  [checked]="isSpecialtyChecked(cat)"
                  (change)="onSpecialtyChange(cat, $event)"
                  class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300 rounded"
                />
              </div>
              <div class="ml-2 text-sm w-full">
                <label
                  [for]="'specialty-' + cat"
                  class="font-medium text-gray-700"
                  >{{ cat | i18n }}</label
                >
              </div>
            </div>
          </ng-container>
        </div>
      </fieldset>
    </div>
  </ng-container>
  <div class="flex flex-col md:flex-row justify-end gap-4 mt-8 w-full">
    <button
      type="button"
      (click)="goToDashboard()"
      class="w-full md:w-auto px-4 py-2 bg-gray-300 text-gray-700 rounded-lg font-semibold hover:bg-gray-400 transition"
    >
      {{ "cancel" | i18n }}
    </button>
    <button
      type="submit"
      class="w-full md:w-auto px-4 py-2 bg-indigo-600 text-white rounded-lg font-semibold hover:bg-indigo-700 transition"
    >
      {{ "saveChanges" | i18n }}
    </button>
  </div>
</form>

<!-- Modal de Verificação de SMS -->
<app-sms-verification-modal
  *ngIf="showSmsModal()"
  [phone]="phone()"
  [smsCode]="smsCode"
  (close)="showSmsModal.set(false)"
  (validate)="validateSmsCode()"
></app-sms-verification-modal>
