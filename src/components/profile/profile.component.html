<!-- Cabeçalho do Perfil com Avatar e Informações -->
<div class="flex flex-col items-center justify-start w-full mb-6 mobile-safe">
  <!-- Container do Avatar -->
  <div class="relative group mb-4">
    <img class="h-28 w-28 md:h-36 md:w-36 rounded-full object-cover shadow-lg ring-4 ring-indigo-100" 
      [src]="user().avatar_url"
      [alt]="user().name"
      aria-label="{{ 'profileAvatar' | i18n }}"
    />
    <div
      class="absolute inset-0 bg-black bg-opacity-50 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity cursor-pointer">
      <div class="flex space-x-4 md:space-x-6">
        <button type="button" (click)="fileInput.click()" [title]="'uploadPhoto' | i18n"
          class="text-white text-xl md:text-2xl hover:text-indigo-200 transition-colors"
          aria-label="{{ 'uploadPhoto' | i18n }}">
          <i class="fas fa-upload"></i>
        </button>
        <button type="button" (click)="openCameraModalWithFocus()" [title]="'useCamera' | i18n"
          class="text-white text-xl md:text-2xl hover:text-indigo-200 transition-colors"
          aria-label="{{ 'useCamera' | i18n }}">
          <i class="fas fa-camera"></i>
        </button>
      </div>
    </div>
    <input type="file" #fileInput hidden (change)="onFileSelected($event)" accept="image/png, image/jpeg, image/gif" aria-label="{{ 'selectPhoto' | i18n }}" />
  </div>
  
  <!-- Informações do Usuário -->
  <div class="flex flex-col items-center gap-1 w-full px-4">
    <!-- Nome do usuário com edição inline -->
    <div class="flex items-center gap-2 group/name">
      @if (!isEditingName()) {
        <h2 class="text-2xl md:text-3xl font-extrabold text-indigo-700 drop-shadow-sm text-center break-words">
          {{ user().name }}
        </h2>
        <button 
          type="button"
          (click)="startEditingName()"
          [title]="'editName' | i18n"
          class="text-indigo-500 hover:text-indigo-700 transition-colors opacity-0 group-hover/name:opacity-100"
          aria-label="{{ 'editName' | i18n }}">
          <i class="fas fa-pencil-alt text-lg"></i>
        </button>
      } @else {
        <div class="flex items-center gap-2">
          <input 
            id="editNameInput"
            type="text" 
            [value]="name()" 
            (input)="name.set($any($event.target).value); checkIfChanged()"
            (keyup.enter)="isEditingName.set(false)"
            (keyup.escape)="name.set(user().name); isEditingName.set(false)"
            class="text-2xl md:text-3xl font-extrabold text-indigo-700 text-center border-b-2 border-indigo-400 focus:outline-none focus:border-indigo-600 bg-transparent px-2"
            aria-label="{{ 'editNameField' | i18n }}"
            autofocus />
          <button 
            type="button"
            (click)="isEditingName.set(false)"
            class="text-green-600 hover:text-green-700 transition-colors"
            aria-label="{{ 'confirmEditName' | i18n }}">
            <i class="fas fa-check text-lg"></i>
          </button>
          <button 
            type="button"
            (click)="name.set(user().name); isEditingName.set(false)"
            class="text-red-500 hover:text-red-700 transition-colors"
            aria-label="{{ 'cancelEditName' | i18n }}">
            <i class="fas fa-times text-lg"></i>
          </button>
        </div>
      }
    </div>
    <p class="text-sm md:text-base text-indigo-500 font-semibold capitalize text-center">
      {{ user().role | i18n }}
    </p>
  </div>
</div>
<form #profileForm="ngForm" (ngSubmit)="saveProfile()"
  class="space-y-7 bg-white/95 shadow-xl rounded-2xl px-0 md:px-12 py-8">
  <!-- Card: Dados Pessoais -->
  <div
    class="rounded-xl border border-indigo-100 bg-white/80 shadow-sm p-4 md:p-6 mb-4 flex flex-col gap-4 w-full mobile-safe">
    <h3 class="text-lg font-bold text-indigo-700 mb-2">
      {{ "personalData" | i18n }}
    </h3>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-8">
      <div class="w-full">
        <label for="email" class="block text-sm font-semibold text-indigo-700 mb-1">{{ "emailAddress" | i18n }}</label>
        <input type="email" id="email" name="email" [ngModel]="email()" disabled
          class="w-full px-4 py-2 border border-gray-200 rounded-lg shadow-sm text-gray-500 bg-gray-100 cursor-not-allowed" />
      </div>
      <div class="w-full flex flex-col">
        <span class="block text-sm font-semibold text-indigo-700 mb-1">{{ "security" | i18n }}</span>
        <button type="button" (click)="showChangePassword.set(true)"
          class="w-full px-4 py-2 bg-indigo-600 text-white rounded-lg font-semibold hover:bg-indigo-700 transition"
          aria-label="{{ 'changePassword' | i18n }}">
          {{ "changePassword" | i18n }}
        </button>
      </div>
    </div>
  </div>

  <!-- Card: Contato e Preferências -->
  <div
    class="rounded-xl border border-indigo-100 bg-white/80 shadow-sm p-4 md:p-6 mb-4 flex flex-col gap-4 w-full mobile-safe">
    <h3 class="text-lg font-bold text-indigo-700 mb-4">
      {{ "contactPreferences" | i18n }}
    </h3>
    <div class="flex flex-col gap-6">
      <div class="flex flex-col md:flex-row items-center gap-4 w-full">
        <div class="flex flex-row items-center w-full gap-1">
          <div class="flex-1 w-full">
            <label for="phone" class="block text-sm font-semibold text-indigo-700 mb-1">{{ "phoneNumber" | i18n }}</label>
            <input type="tel" id="phone" name="phone" [ngModel]="phone()"
              (ngModelChange)="phone.set($event); checkIfChanged()"
              pattern="^\+[1-9]{1}[0-9]{1,2} ?[0-9]{3,}([ \-]?[0-9]{2,}){1,}$"
              class="w-full md:w-48 max-w-full px-4 py-2 border border-indigo-200 rounded-lg shadow-sm placeholder-indigo-300 focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:border-indigo-400 transition-all duration-150 bg-indigo-50/40"
              [placeholder]="'phonePlaceholder' | i18n"
              aria-label="{{ 'phoneNumber' | i18n }}" />
          </div>
          <div class="flex-1 w-full">
            <ng-container *ngIf="
                user().phone != null &&
                user().phone.trim() !== '' &&
                !user().phone_verified
              ">
              <div class="flex justify-end w-full md:w-64">
                <button type="button" (click)="sendSmsVerification()"
                  class="w-full px-6 py-2 bg-indigo-500 text-white rounded-lg font-semibold hover:bg-indigo-600 transition whitespace-nowrap"
                  aria-label="{{ 'sendVerificationCode' | i18n }}">
                  {{ "sendVerificationCode" | i18n }}
                </button>
              </div>
            </ng-container>
          </div>
        </div>
      </div>
      <div class="flex items-center gap-3">
        <input type="checkbox" name="receiveSmsNotifications" [(ngModel)]="receiveSmsNotifications"
          class="form-checkbox h-4 w-4 text-indigo-600" aria-label="{{ 'receiveSmsNotifications' | i18n }}" />
        <span class="text-sm text-indigo-700 font-semibold">{{
          "receiveSmsNotifications" | i18n
          }}</span>
      </div>
      <div *ngIf="profileForm.controls.phone?.invalid && profileForm.controls.phone?.dirty" class="text-red-500 text-xs mt-1">
        {{ "phoneFormatError" | i18n }}
      </div>
      <span *ngIf="smsSent" class="text-green-600 text-xs mt-1">{{
        "smsSentInfo" | i18n
        }}</span>
      <div *ngIf="!user().phone_verified && user().sms_code"
        class="flex flex-col md:flex-row md:items-center gap-3 mt-2">
        <label for="smsCode" class="block text-sm font-semibold text-indigo-700 mb-1">{{ "smsCodeLabel" | i18n
          }}</label>
        <input type="text" id="smsCode" name="smsCode" [(ngModel)]="smsCode" maxlength="6"
          class="w-full md:w-32 px-2 py-1 border border-indigo-200 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-400"
          [placeholder]="'smsCodePlaceholder' | i18n"
          aria-label="{{ 'smsCodeLabel' | i18n }}" />
        <button type="button" (click)="validateSmsCode()"
          class="w-full md:w-40 px-4 py-2 bg-green-500 text-white rounded-lg font-semibold hover:bg-green-600 transition"
          aria-label="{{ 'validateCode' | i18n }}">
          {{ "validateCode" | i18n }}
        </button>
        <span *ngIf="smsValid === true" class="text-green-600 text-xs ml-2">{{
          "smsCodeValid" | i18n
          }}</span>
      </div>
      <div *ngIf="lastNotification()" class="text-red-500 text-xs mt-2" aria-live="polite">
        {{ lastNotification() }}
      </div>
    </div>
  </div>

  <!-- Card: Especialidades -->
  <ng-container *ngIf="user().role === 'professional'">
    <div
      class="rounded-xl border border-indigo-100 bg-white/80 shadow-sm p-4 md:p-6 mb-4 flex flex-col gap-4 w-full">
      <h3 class="text-lg font-bold text-indigo-700 mb-2">
        {{ "mySpecialties" | i18n }}
      </h3>
      <fieldset>
        <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
          <ng-container *ngFor="let cat of allCategories()">
            <div class="flex items-start w-full">
              <div class="flex items-center h-5">
                <input [id]="'specialty-' + cat.id" type="checkbox" [checked]="isSpecialtyChecked(cat)"
                  (change)="onSpecialtyChange(cat, $event)"
                  class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300 rounded"
                  aria-label="{{ cat.name | i18n }}" />
              </div>
              <div class="ml-2 text-sm w-full">
                <label [for]="'specialty-' + cat.id" class="font-medium text-gray-700">{{ cat.name | i18n }}</label>
              </div>
            </div>
          </ng-container>
        </div>
      </fieldset>
    </div>
  </ng-container>

  <div class="flex flex-col md:flex-row justify-end gap-4 mt-8 w-full">
    <button type="button" (click)="goToDashboard()"
      class="w-full md:w-auto px-4 py-2 bg-gray-300 text-gray-700 rounded-lg font-semibold hover:bg-gray-400 transition"
      aria-label="{{ 'cancel' | i18n }}">
      {{ "cancel" | i18n }}
    </button>
    <button type="submit"
      class="w-full md:w-auto px-4 py-2 bg-indigo-600 text-white rounded-lg font-semibold hover:bg-indigo-700 transition"
      aria-label="{{ 'saveChanges' | i18n }}">
      {{ "saveChanges" | i18n }}
    </button>
  </div>
</form>

<!-- Modal de Verificação de SMS -->
<app-sms-verification-modal *ngIf="showSmsModal()" [phone]="phone()" [smsCode]="smsCode"
  (close)="showSmsModal.set(false)" (validate)="validateSmsCode()"></app-sms-verification-modal>

<!-- Modal de Alteração de Senha -->
<app-change-password *ngIf="showChangePassword()"
  (closeModal)="showChangePassword.set(false)"></app-change-password>

<!-- Camera Modal -->
<div *ngIf="showCameraModal()"
  class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-75 p-4">
  <div class="bg-white rounded-lg shadow-xl overflow-hidden max-w-lg w-full">
    <div class="p-4 bg-indigo-600 text-white flex justify-between items-center">
      <h3 class="text-lg font-semibold">{{ 'takePhoto' | i18n }}</h3>
      <button type="button" (click)="closeCameraModal()" class="text-white hover:text-gray-200" aria-label="{{ 'closeCameraModal' | i18n }}">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="relative bg-black aspect-[4/3] flex items-center justify-center">
      <video #videoElement tabindex="0" aria-label="{{ 'cameraPreview' | i18n }}" autoplay playsinline muted class="w-full h-full object-cover outline-none"></video>
    </div>
    <div class="p-4 flex justify-center gap-4 bg-gray-50">
      <button type="button" (click)="capturePhoto()"
        class="px-6 py-2 bg-indigo-600 text-white rounded-full font-semibold hover:bg-indigo-700 transition flex items-center gap-2"
        aria-label="{{ 'capturePhoto' | i18n }}">
        <i class="fas fa-camera"></i>
        {{ 'capture' | i18n }}
      </button>
      <button type="button" (click)="closeCameraModal()"
        class="px-6 py-2 bg-gray-300 text-gray-700 rounded-full font-semibold hover:bg-gray-400 transition"
        aria-label="{{ 'cancel' | i18n }}">
        {{ 'cancel' | i18n }}
      </button>
    </div>
  </div>
</div>

<!-- Toast/Banner de feedback visual -->
<div *ngIf="showSaveToast()" class="fixed bottom-4 left-1/2 transform -translate-x-1/2 z-50 px-6 py-3 rounded-xl shadow-lg font-semibold text-center text-white text-base md:text-lg"
  [ngClass]="{
    'bg-green-600': saveToastType() === 'success',
    'bg-red-600': saveToastType() === 'error'
  }"
  aria-live="assertive"
  role="status">
  {{ saveToastMessage() }}
</div>