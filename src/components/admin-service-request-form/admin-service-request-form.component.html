<div class="admin-service-request-form space-y-4 sm:space-y-6 min-w-0 overflow-hidden px-2 sm:px-0">
  <div class="form-header">
    <h2 class="form-title wrap-break-word">
      {{ 'createServiceRequest' | i18n }}
    </h2>
    <p class="form-description">
      {{ 'serviceRequestDescription' | i18n }}
    </p>
  </div>

  <div class="form-card">
    <form (ngSubmit)="submitRequest()" #form="ngForm" class="space-y-4">
      <!-- Origem da solicitação -->
      <div class="form-section">
        <h3 class="section-title">Origem da Solicitação</h3>
        <div class="flex flex-col sm:flex-row gap-4">
          <div class="flex-1">
            <label for="origin_id" class="form-label">{{ 'origin' | i18n }}</label>
            <select id="origin_id" name="origin_id" [ngModel]="newRequest().origin_id" (ngModelChange)="updateNewRequest('origin_id', +$event)" required class="form-control">
              <option value="0" disabled>{{ 'selectOrigin' | i18n }}</option>
              @for (origin of origins(); track origin.id) {
                <option [value]="origin.id">{{ origin.name }}</option>
              }
            </select>
          </div>
          
          <!-- Campo OS (Ordem de Serviço) -->
          <div class="flex-1">
            <label for="os" class="form-label">{{ 'osOptional' | i18n }}</label>
            <input type="text" id="os" name="os" [ngModel]="newRequest().os" (ngModelChange)="updateNewRequest('os', $event)" pattern="[0-9]*" inputmode="numeric" maxlength="30" placeholder="Ex: 2816446" class="form-control">
          </div>
        </div>
      </div>

      <!-- Service Details Section -->
      <div class="form-section">
        <h3 class="section-title">{{ 'serviceDetails' | i18n }}</h3>
        <div class="grid grid-cols-1 gap-4">
          <div>
            <label for="title" class="form-label">{{ 'title' | i18n }}</label>
            <input type="text" id="title" name="title" [ngModel]="newRequest().title" (ngModelChange)="updateNewRequest('title', $event)" required class="form-control">
          </div>
          <div>
            <label for="description" class="form-label">{{ 'description' | i18n }}</label>
            <textarea id="description" name="description" [ngModel]="newRequest().description" (ngModelChange)="updateNewRequest('description', $event)" required rows="3" class="form-control"></textarea>
          </div>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div>
              <label for="category" class="form-label">{{ 'category' | i18n }}</label>
              <select id="category" name="category" [ngModel]="newRequest().category_id" (change)="onCategoryChange($event)" required class="form-control">
                <option value="0" disabled>{{ 'selectCategory' | i18n }}</option>
                @for (category of categories(); track category.id) {
                  <option [value]="category.id">{{ category.name | i18n }}</option>
                }
              </select>
            </div>
            <div>
              <label for="subcategory" class="form-label">{{ 'subcategory' | i18n }}</label>
              <select id="subcategory" name="subcategory" [ngModel]="newRequest().subcategory_id" (ngModelChange)="updateNewRequest('subcategory_id', +$event)" required [disabled]="!newRequest().category_id" class="form-control disabled:opacity-50">
                <option value="0" disabled>{{ 'selectSubcategory' | i18n }}</option>
                @for (subcategory of subcategories(); track subcategory.id) {
                  <option [value]="subcategory.id">{{ subcategory.name | i18n }}</option>
                }
              </select>
            </div>
          </div>
        </div>
      </div>

      <!-- Requester Info Section -->
      <div class="form-section">
        <h3 class="section-title">{{ 'requesterInfo' | i18n }}</h3>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div>
            <label for="requester_name" class="form-label">{{ 'client' | i18n }}</label>
            <input type="text" id="requester_name" name="requester_name" [ngModel]="newRequest().requester_name" (ngModelChange)="updateNewRequest('requester_name', $event)" required class="form-control">
          </div>
          <div>
            <label for="requester_phone" class="form-label">{{ 'phone' | i18n }}</label>
            <input type="tel" id="requester_phone" name="requester_phone" [ngModel]="newRequest().requester_phone" (ngModelChange)="updateNewRequest('requester_phone', $event)" required class="form-control">
          </div>
          <div>
            <label for="requester_nif" class="form-label">{{ 'nif' | i18n }} ({{ 'optional' | i18n }})</label>
            <input type="text" id="requester_nif" name="requester_nif" [ngModel]="newRequest().requester_nif" (ngModelChange)="updateNewRequest('requester_nif', $event)" class="form-control">
          </div>
        </div>
      </div>

      <!-- Address Section -->
      <div class="form-section">
        <h3 class="section-title">{{ 'address' | i18n }}</h3>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div class="sm:col-span-2">
            <label for="street" class="form-label">{{ 'street' | i18n }}</label>
            <input type="text" id="street" name="street" [ngModel]="newRequest().street" (ngModelChange)="updateNewRequest('street', $event)" required class="form-control">
          </div>
          <div class="relative">
            <label for="postal_code" class="form-label">{{ 'postalCode' | i18n }}</label>
            <input type="text" id="postal_code" name="postal_code" [ngModel]="newRequest().postal_code" (ngModelChange)="onPostalCodeChange($event)" required placeholder="0000-000" class="form-control" [class.is-invalid]="!isPostalCodeValid()" [class.is-valid]="isPostalCodeValid()">
            @if (!isPostalCodeValid()) {
              <p class="validation-message">{{ 'invalidPostalCode' | i18n }}</p>
            }
            @if (postalCodeSuggestions().length > 0) {
              <ul class="suggestion-list">
                @for (suggestion of postalCodeSuggestions(); track suggestion) {
                  <li><button type="button" (click)="selectSuggestion('postal_code', suggestion)" class="suggestion-item">{{ suggestion }}</button></li>
                }
              </ul>
            }
          </div>
          <div class="relative">
            <label for="locality" class="form-label">{{ 'locality' | i18n }}</label>
            <input type="text" id="locality" name="locality" [ngModel]="newRequest().locality" (ngModelChange)="onLocalityChange($event)" required class="form-control">
            @if (localitySuggestions().length > 0) {
              <ul class="suggestion-list">
                @for (suggestion of localitySuggestions(); track suggestion) {
                  <li><button type="button" (click)="selectSuggestion('locality', suggestion)" class="suggestion-item">{{ suggestion }}</button></li>
                }
              </ul>
            }
          </div>
          <div>
            <label for="district" class="form-label">{{ 'district' | i18n }}</label>
            <select id="district" name="district" [ngModel]="newRequest().district" (ngModelChange)="updateNewRequest('district', $event)" required class="form-control">
              <option value="" disabled>{{ 'selectDistrict' | i18n }}</option>
              @for (district of districts(); track district) {
                <option [value]="district">{{ district }}</option>
              }
            </select>
          </div>
        </div>
        <div class="grid grid-cols-1 gap-4 mt-4">
           <div>
            <label for="location_details" class="form-label">{{ 'locationDetails' | i18n }} ({{ 'optional' | i18n }})</label>
            <input type="text" id="location_details" name="location_details" [ngModel]="newRequest().location_details" (ngModelChange)="updateNewRequest('location_details', $event)" placeholder="{{ 'locationDetailsPlaceholder' | i18n }}" class="form-control">
          </div>
          <div>
            <label for="location_access_notes" class="form-label">{{ 'locationAccessNotes' | i18n }} ({{ 'optional' | i18n }})</label>
            <textarea id="location_access_notes" name="location_access_notes" [ngModel]="newRequest().location_access_notes" (ngModelChange)="updateNewRequest('location_access_notes', $event)" rows="2" placeholder="{{ 'locationAccessNotesPlaceholder' | i18n }}" class="form-control"></textarea>
          </div>
        </div>
      </div>

      <!-- Urgency and Deadline Section -->
      <div class="form-section">
        <h3 class="section-title">{{ 'priority' | i18n }}</h3>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div>
            <label for="urgency" class="form-label">{{ 'urgency' | i18n }}</label>
            <select id="urgency" name="urgency" [ngModel]="newRequest().urgency" (ngModelChange)="updateNewRequest('urgency', $event)" required class="form-control">
              @for (level of urgencyLevels; track level) {
                <option [value]="level">{{ 'urgency_' + level | i18n }}</option>
              }
            </select>
          </div>
          <div>
            <label for="service_deadline" class="form-label">{{ 'serviceDeadline' | i18n }} ({{ 'optional' | i18n }})</label>
            <input type="date" id="service_deadline" name="service_deadline" [ngModel]="newRequest().service_deadline" (ngModelChange)="updateNewRequest('service_deadline', $event)" class="form-control">
          </div>
        </div>
      </div>

      <!-- Actions -->
      <div class="form-actions">
        <button type="button" (click)="cancel()" class="btn-secondary">{{ 'cancel' | i18n }}</button>
        <button type="submit" [disabled]="form.invalid" class="btn-primary">{{ 'create' | i18n }}</button>
      </div>
    </form>
  </div>
</div>
