<form
  autocomplete="off"
  (ngSubmit)="onSubmit()"
  class="w-full px-0 mobile-safe space-y-4 md:space-y-7 relative"
>
  <!-- Overlay spinner central -->
  <div
    *ngIf="isSubmitting()"
    class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-30"
  >
    <div class="flex flex-col items-center">
      <svg
        class="animate-spin h-12 w-12 text-indigo-600 mb-4"
        xmlns="http://www.w3.org/2000/svg"
        fill="none"
        viewBox="0 0 24 24"
      >
        <circle
          class="opacity-25"
          cx="12"
          cy="12"
          r="10"
          stroke="currentColor"
          stroke-width="4"
        ></circle>
        <path
          class="opacity-75"
          fill="currentColor"
          d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"
        ></path>
      </svg>
      <span class="text-white text-lg font-semibold drop-shadow">{{
        "loading" | i18n
      }}</span>
    </div>
  </div>
  <!-- Categoria -->
  <div>
    <label class="block text-sm font-medium mb-1" for="category">
      {{ "category" | i18n }}
    </label>
    <select
      id="category"
      class="w-full border rounded px-3 py-2"
      [value]="category()"
      (change)="updateField('category', $event.target.value)"
      required
    >
      <option value="" disabled selected>{{ "select" | i18n }}</option>
      <ng-container *ngFor="let cat of categories()">
        <option [value]="cat">{{ cat }}</option>
      </ng-container>
    </select>
    <span
      *ngIf="!validFields().category && category()"
      class="text-xs text-red-500"
      >{{ "selectCategory" | i18n }}</span
    >
  </div>

  <!-- Título -->
  <div>
    <label class="block text-sm font-medium mb-1" for="title">{{
      "title" | i18n
    }}</label>
    <input
      id="title"
      type="text"
      class="w-full border rounded px-3 py-2"
      [value]="title()"
      (input)="updateField('title', $event.target.value)"
      required
      minlength="3"
      [placeholder]="'titlePlaceholder' | i18n"
    />
    <span *ngIf="!validFields().title && title()" class="text-xs text-red-500">
      {{ "titleMinLength" | i18n }}
    </span>
  </div>

  <!-- Descrição -->
  <div>
    <label class="block text-sm font-medium mb-1" for="description">
      {{ "description" | i18n }}
    </label>
    <textarea
      id="description"
      class="w-full border rounded px-3 py-2"
      [value]="description()"
      (input)="updateField('description', $event.target.value)"
      required
      minlength="10"
      [placeholder]="'descriptionPlaceholder' | i18n"
    ></textarea>
    <span
      *ngIf="!validFields().description && description()"
      class="text-xs text-red-500"
    >
      {{ "descriptionMinLength" | i18n }}
    </span>
  </div>

  <!-- Data/Hora solicitada -->
  <div>
    <label class="block text-sm font-medium mb-1" for="requestedDateTime">
      {{ "dateTime" | i18n }}
    </label>
    <input
      id="requestedDateTime"
      type="datetime-local"
      class="w-full border rounded px-3 py-2"
      [value]="requestedDateTime()"
      (input)="updateField('requestedDateTime', $event.target.value)"
      required
      [placeholder]="'dateTimePlaceholder' | i18n"
    />
    <span
      *ngIf="!validFields().requestedDateTime && requestedDateTime()"
      class="text-xs text-red-500"
    >
      {{ "validFutureDateTime" | i18n }}
    </span>
  </div>

  <!-- Endereço -->
  <fieldset
    class="grid grid-cols-1 md:grid-cols-2 gap-4 border rounded p-4 mt-2"
  >
    <legend class="text-base font-semibold mb-2 px-2">
      {{ "address" | i18n }}
    </legend>
    <div>
      <label class="block text-sm font-medium mb-1" for="zip_code">
        {{ "postalCode" | i18n }}
      </label>
      <input
        id="zip_code"
        type="text"
        class="w-full border rounded px-3 py-2"
        [value]="zip_code()"
        (input)="updateField('zip_code', $event.target.value)"
        (paste)="onZipCodePaste($event)"
        required
        pattern="\d{4}-\d{3}"
        maxlength="8"
        inputmode="numeric"
        [placeholder]="'postalCodePlaceholder' | i18n"
        autocomplete="postal-code"
      />
      <span
        *ngIf="!validFields().zip_code && zip_code()"
        class="text-xs text-red-500"
      >
        {{ formError() ? formError() : ("invalidPostalCode" | i18n) }}
      </span>
    </div>
    <div>
      <label class="block text-sm font-medium mb-1" for="street">
        {{ "logradouro" | i18n }}
      </label>
      <input
        id="street"
        type="text"
        class="w-full border rounded px-3 py-2 bg-gray-100"
        [value]="street()"
        readonly
        required
        minlength="5"
        [placeholder]="'streetPlaceholder' | i18n"
      />
    </div>
    <div>
      <label class="block text-sm font-medium mb-1" for="number">
        {{ "number" | i18n }}
      </label>
      <input
        id="number"
        type="text"
        class="w-full border rounded px-3 py-2"
        [value]="number()"
        (input)="updateField('number', $event.target.value)"
        required
        [placeholder]="'numberPlaceholder' | i18n"
      />
    </div>
    <div>
      <label class="block text-sm font-medium mb-1" for="complement">
        {{ "complement" | i18n }}
      </label>
      <input
        id="complement"
        type="text"
        class="w-full border rounded px-3 py-2"
        [value]="complement()"
        (input)="updateField('complement', $event.target.value)"
        [placeholder]="'complementPlaceholder' | i18n"
      />
    </div>
    <div>
      <label class="block text-sm font-medium mb-1" for="locality">
        {{ "locality" | i18n }}
      </label>
      <input
        id="locality"
        type="text"
        class="w-full border rounded px-3 py-2 bg-gray-100"
        [value]="locality()"
        readonly
        [placeholder]="'localityPlaceholder' | i18n"
      />
    </div>
    <div>
      <label class="block text-sm font-medium mb-1" for="city">
        {{ "concelho" | i18n }}
      </label>
      <input
        id="city"
        type="text"
        class="w-full border rounded px-3 py-2 bg-gray-100"
        [value]="county()"
        readonly
        [placeholder]="'cityPlaceholder' | i18n"
      />
      <span *ngIf="!validFields().city && city()" class="text-xs text-red-500">
        {{ "cityMinLength" | i18n }}
      </span>
    </div>
    <div>
      <label class="block text-sm font-medium mb-1" for="district">
        {{ "district" | i18n }}
      </label>
      <input
        id="district"
        type="text"
        class="w-full border rounded px-3 py-2 bg-gray-100"
        [value]="district()"
        readonly
        [placeholder]="'districtPlaceholder' | i18n"
      />
    </div>
  </fieldset>

  <!-- Mensagens de erro/sucesso -->
  <div *ngIf="formError()" class="text-red-600 text-sm mt-2">
    {{ formError() }}
  </div>
  <div *ngIf="formSuccess()" class="text-green-600 text-sm mt-2">
    {{ formSuccess() }}
  </div>

  <!-- Botões -->
  <div class="flex justify-end gap-2 mt-6">
    <button
      type="button"
      class="px-4 py-2 rounded bg-gray-300 hover:bg-gray-400"
      (click)="close.emit()"
    >
      {{ "cancel" | i18n }}
    </button>
    <button
      type="submit"
      class="px-4 py-2 rounded bg-indigo-600 text-white font-semibold hover:bg-indigo-700 flex items-center justify-center min-w-[110px]"
      [disabled]="!isFormValid() || isSubmitting()"
    >
      {{ "submit" | i18n }}
    </button>
    <span
      class="ml-4 text-xs"
      [ngClass]="isFormValid() ? 'text-green-600' : 'text-red-600'"
    >
      {{ isFormValid() ? "Formulário válido" : "Formulário inválido" }}
    </span>
  </div>
</form>
