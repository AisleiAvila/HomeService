<!-- Modal de erro de negócio -->

@if (showBusinessError()) {
<div
  class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-30"
>
  <div
    class="bg-white rounded-lg shadow-lg p-6 max-w-sm w-full text-center border border-red-300"
  >
    <div class="text-red-600 text-lg font-semibold mb-2">
      {{ businessErrorMessage() }}
    </div>
    <button
      class="mt-4 px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600"
      (click)="showBusinessError.set(false)"
    >
      OK
    </button>
  </div>
</div>
}

<div class="space-y-4 sm:space-y-6 min-w-0 overflow-hidden px-2 sm:px-0">
  <div>
    <h2 class="text-xl sm:text-2xl font-bold text-gray-800 break-words">
      {{ "welcomeBack" | i18n : { name: user().name } }}
    </h2>
    <p class="text-gray-500 text-sm sm:text-base">
      {{ "dashboardSummary" | i18n }}
    </p>
  </div>

  <!-- Stats Cards -->
  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4">
    @for (stat of stats(); track stat.label) {
    <div
      class="bg-white p-4 sm:p-6 rounded-lg shadow flex items-center space-x-3 sm:space-x-4 min-w-0"
    >
      <div
        class="flex-shrink-0 w-10 h-10 sm:w-12 sm:h-12 flex items-center justify-center rounded-full"
        [class.bg-yellow-100]="stat.icon.includes('yellow')"
        [class.bg-blue-100]="stat.icon.includes('blue')"
        [class.bg-green-100]="stat.icon.includes('green')"
        [class.bg-emerald-100]="stat.icon.includes('emerald')"
      >
        <i class="text-lg sm:text-2xl" [class]="stat.icon"></i>
      </div>
      <div class="flex-1 min-w-0">
        <span class="font-semibold text-gray-700">{{ stat.label }}</span>
        <span class="ml-2 text-gray-900">{{ stat.value }}</span>
      </div>
    </div>
    }
  </div>

  <!-- Service Lists OU Detalhes -->
  @if (selectedRequest()) {
  <app-service-request-details
    [request]="selectedRequest()"
    [currentUser]="user()"
    (close)="selectedRequest.set(null)"
    (refreshRequest)="selectedRequest.set(null)"
  ></app-service-request-details>
  } @else {
  
  <!-- Lista de Solicitações com Filtros Integrados -->
  <div class="bg-white rounded-lg shadow-md overflow-hidden">
    <!-- Filtros Avançados e Pesquisa -->
    <div class="p-4 border-b border-gray-200 bg-gray-50 space-y-4">
      <!-- Filtros Rápidos -->
      <div class="flex flex-wrap items-center gap-2">
        <span class="text-sm font-semibold text-gray-700 mr-2"
          >{{ "quickFilters" | i18n }}:</span
        >
        @for(quickFilter of quickFilterOptions; track quickFilter.status) {
        <button
          (click)="applyQuickFilter(quickFilter.status)"
          [class]="
            'px-3 py-1 text-xs font-medium rounded-full ' +
            (filterStatus() === quickFilter.status
              ? 'bg-blue-600 text-white'
              : 'bg-gray-200 text-gray-700 hover:bg-gray-300')
          "
        >
          {{ quickFilter.label | i18n }}
        </button>
        }
      </div>

      <!-- Filtros Avançados -->
      <div class="flex flex-wrap gap-4 items-end">
        <!-- Filtro de Status (Dropdown) -->
        <div>
          <label class="block text-xs font-semibold text-gray-600 mb-1">{{
            "status" | i18n
          }}</label>
          <select
            [ngModel]="filterStatus()"
            (ngModelChange)="filterStatus.set($event)"
            class="border border-gray-300 rounded px-2 py-1 text-sm"
          >
            <option value="">{{ "all" | i18n }}</option>
            @for(status of statusAtivos(); track status.value) {
            <option [value]="status.value">{{ status.label }}</option>
            }
          </select>
        </div>

        <!-- Filtro por Período -->
        <div>
          <label class="block text-xs font-semibold text-gray-600 mb-1">{{
            "period" | i18n
          }}</label>
          <div class="flex items-center gap-2">
            <input
              type="date"
              [ngModel]="filterStartDate()"
              (ngModelChange)="filterStartDate.set($event)"
              class="border rounded px-2 py-1 text-sm"
            />
            <span class="text-gray-500">-</span>
            <input
              type="date"
              [ngModel]="filterEndDate()"
              (ngModelChange)="filterEndDate.set($event)"
              class="border rounded px-2 py-1 text-sm"
            />
          </div>
        </div>

        <!-- Filtro por Categoria -->
        <div>
          <label class="block text-xs font-semibold text-gray-600 mb-1">{{
            "category" | i18n
          }}</label>
          <select
            [ngModel]="filterCategory()"
            (ngModelChange)="filterCategory.set($event)"
            class="border rounded px-2 py-1 text-sm"
          >
            <option value="">{{ "all" | i18n }}</option>
            @for(cat of dataService.categories(); track cat.id) {
            <option [value]="cat.id">{{ cat.name }}</option>
            }
          </select>
        </div>

        <!-- Barra de Pesquisa -->
        <div class="flex-1 min-w-[200px]">
          <label class="block text-xs font-semibold text-gray-600 mb-1">{{
            "search" | i18n
          }}</label>
          <input
            type="text"
            [ngModel]="searchTerm()"
            (ngModelChange)="searchTerm.set($event)"
            placeholder="{{ 'searchPlaceholder' | i18n }}"
            class="border rounded px-2 py-1 text-sm w-full"
          />
        </div>
        
        <button
          (click)="clearFilters()"
          class="px-3 py-1 text-xs bg-gray-300 rounded hover:bg-gray-400"
        >
          {{ "clearFilters" | i18n }}
        </button>
      </div>

      <!-- Indicadores de Filtros Ativos -->
      @if (activeFilters().length > 0) {
      <div
        class="flex flex-wrap items-center gap-2 pt-3 border-t border-gray-200"
      >
        <span class="text-sm font-medium text-gray-600"
          >{{ "activeFilters" | i18n }}:</span
        >
        @for(filter of activeFilters(); track filter.type) {
        <span
          class="inline-flex items-center gap-x-1.5 py-1.5 px-3 rounded-full text-xs font-medium bg-teal-100 text-teal-800"
        >
          {{ filter.label | i18n }}: {{ filter.value }}
          <button
            (click)="removeFilter(filter.type)"
            class="flex-shrink-0 h-4 w-4 rounded-full inline-flex items-center justify-center text-teal-600 hover:bg-teal-200 hover:text-teal-500"
          >
            <i class="fas fa-times text-xs"></i>
          </button>
        </span>
        }
      </div>
      }
    </div>

    <!-- Lista de Solicitações -->
    @if (user() && isArray(paginatedRequests()) && paginatedRequests().length > 0) {
    <app-service-list
      [serviceRequests]="paginatedRequests() || []"
      [currentUser]="user()"
      [enablePagination]="false"
      [sortBy]="sortBy()"
      [sortOrder]="sortOrder()"
      (sortChange)="sortByColumn($event)"
      (viewDetails)="handleViewDetails($event)"
      (openChat)="openChat.emit($event)"
      (payNow)="payNow.emit($event)"
      (approveQuote)="handleQuoteResponse($event, true)"
      (rejectQuote)="handleQuoteResponse($event, false)"
      (approveExecutionDate)="handleExecutionDateResponse($event, true)"
      (rejectExecutionDate)="
        handleExecutionDateResponse($event.request, false, $event.reason)
      "
      (scheduleRequest)="scheduleRequest.emit($event)"
      (provideClarification)="handleProvideClarification($event)"
      (finishService)="handleFinishService($event)"
    >
    </app-service-list>
    
    <!-- Pagination Controls -->
    @if(filteredRequests().length > 0) {
    <div
      class="bg-white px-4 py-3 flex flex-col sm:flex-row sm:items-center sm:justify-between border-t border-gray-200 space-y-3 sm:space-y-0"
    >
      <!-- Items per page selector -->
      <div class="flex items-center space-x-2">
        <span class="text-sm text-gray-700"
          >{{ "itemsPerPage" | i18n }}:</span
        >
        <select
          [value]="itemsPerPage()"
          (change)="setItemsPerPage(+$any($event.target).value)"
          class="border border-gray-300 rounded-md px-2 py-1 text-sm"
        >
          <option value="5">5</option>
          <option value="10">10</option>
          <option value="25">25</option>
          <option value="50">50</option>
        </select>
      </div>

      <!-- Pagination info (hidden on mobile) -->
      <div class="hidden sm:block">
        <p class="text-sm text-gray-700">
          {{ "showing" | i18n }}
          <span class="font-medium">{{
            (currentPage() - 1) * itemsPerPage() + 1
          }}</span>
          {{ "to" | i18n }}
          <span class="font-medium">{{
            Math.min(currentPage() * itemsPerPage(), filteredRequests().length)
          }}</span>
          {{ "of" | i18n }}
          <span class="font-medium">{{ filteredRequests().length }}</span>
          {{ "results" | i18n }}
        </p>
      </div>

      <!-- Pagination buttons -->
      <div class="flex justify-center sm:justify-end">
        <nav
          class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px"
          aria-label="Pagination"
        >
          <!-- Previous button -->
          <button
            (click)="previousPage()"
            [disabled]="currentPage() === 1"
            class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
          >
            <i class="fas fa-chevron-left"></i>
            <span class="sr-only">Previous</span>
          </button>

          <!-- Page numbers (simplified for mobile) -->
          <div class="hidden sm:flex">
            @for(page of pageNumbers; track page) { @if(page === -1) {
            <!-- Ellipsis -->
            <span
              class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700"
            >
              ...
            </span>
            } @else {
            <button
              (click)="goToPage(page)"
              [class]="
                page === currentPage()
                  ? 'relative inline-flex items-center px-4 py-2 border border-gray-300 bg-indigo-50 text-sm font-medium text-indigo-600'
                  : 'relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50'
              "
            >
              {{ page }}
            </button>
            } }
          </div>

          <!-- Mobile page indicator -->
          <div
            class="sm:hidden relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700"
          >
            {{ currentPage() }} / {{ totalPages() }}
          </div>

          <!-- Next button -->
          <button
            (click)="nextPage()"
            [disabled]="currentPage() === totalPages()"
            class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
          >
            <i class="fas fa-chevron-right"></i>
            <span class="sr-only">Next</span>
          </button>
        </nav>
      </div>
    </div>
    }
    
    } @else {
    <div class="text-center text-gray-500 p-6">
      {{ "noRequestsFound" | i18n }}
    </div>
    }
  </div>
  }
</div>
