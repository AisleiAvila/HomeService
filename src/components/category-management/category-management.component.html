<div class="container mx-auto p-6">
  <!-- Cabeçalho e botão adicionar -->
  <div class="flex justify-between items-center mb-6">
    <h3 class="text-xl font-semibold">{{ "serviceCategories" | i18n }}</h3>
    <button
      (click)="showAddCategoryModal.set(true)"
      class="px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-md hover:bg-indigo-700 flex items-center gap-2"
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        class="h-4 w-4"
        fill="none"
        viewBox="0 0 24 24"
        stroke="currentColor"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M12 4v16m8-8H4"
        />
      </svg>
      {{ "addNewCategory" | i18n }}
    </button>
  </div>

  <div class="overflow-x-auto">
    <table class="min-w-full bg-white shadow-lg rounded-lg overflow-hidden">
      <thead class="bg-gradient-to-r from-indigo-600 to-indigo-800">
        <tr>
          <th class="px-6 py-3 text-left text-sm font-bold text-white">
            Categoria
          </th>
          <th class="px-6 py-3 text-left text-sm font-bold text-white">
            Total Subcategorias
          </th>
          <th class="px-6 py-3 text-left text-sm font-bold text-white">
            Ações
          </th>
        </tr>
      </thead>
      <tbody class="divide-y divide-gray-200">
        <ng-container *ngFor="let cat of allCategories(); trackBy: trackById">
          <tr class="hover:bg-gray-50">
            <td class="px-6 py-4 text-lg font-medium text-gray-800">
              <div class="flex items-center gap-3">
                <!-- Toggle button before the category name (shows + when collapsed, − when expanded) -->
                <button
                  type="button"
                  (click)="toggleExpand(cat.id)"
                  class="w-6 h-6 flex items-center justify-center rounded border text-sm bg-white hover:bg-gray-100"
                  [attr.aria-expanded]="isExpanded(cat.id)"
                  [attr.aria-label]="
                    isExpanded(cat.id) ? ('collapse' | i18n) : ('expand' | i18n)
                  "
                >
                  <span class="font-bold">{{
                    isExpanded(cat.id) ? "−" : "+"
                  }}</span>
                </button>

                <!-- Category name becomes bold when it has subcategories -->
                <span
                  [class.font-semibold]="
                    (subcategoryCounts().get(cat.id) || 0) > 0
                  "
                  class="text-gray-800"
                >
                  {{ cat.name }}
                </span>
              </div>
            </td>
            <td class="px-6 py-4 text-gray-800">
              {{ subcategoryCounts().get(cat.id) || 0 }}
            </td>
            <td class="px-6 py-4">
              <div class="flex gap-2">
                <button
                  type="button"
                  (click)="showDetails(cat)"
                  class="px-3 py-1.5 bg-gray-700 text-white rounded-md hover:bg-gray-800 text-sm"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="h-4 w-4"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M8 7l4-4 4 4m0 10l-4 4-4-4"
                    />
                  </svg>
                  {{ "details" | i18n }}
                </button>
                <button
                  type="button"
                  (click)="startEditCategory(cat)"
                  class="px-3 py-1.5 bg-blue-500 text-white rounded-md hover:bg-blue-600 text-sm"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="h-4 w-4"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"
                    />
                  </svg>
                  {{ "edit" | i18n }}
                </button>
                <button
                  type="button"
                  (click)="requestDeleteCategory(cat)"
                  class="px-3 py-1.5 bg-red-500 text-white rounded-md hover:bg-red-600 text-sm"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="h-4 w-4"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
                    />
                  </svg>
                  {{ "delete" | i18n }}
                </button>
                <button
                  type="button"
                  (click)="manageSubcategories(cat)"
                  class="px-3 py-1.5 bg-green-500 text-white rounded-md hover:bg-green-600 text-sm"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="h-4 w-4"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M12 4v16m8-8H4"
                    />
                  </svg>
                  {{ "addSubcategory" | i18n }}
                </button>
                <!-- Expand/collapse control removed from actions (use the leading toggle instead) -->
              </div>
            </td>
          </tr>

          <tr *ngIf="isExpanded(cat.id)" class="bg-gray-50">
            <td colspan="3" class="px-6 py-4">
              <div class="pl-4">
                <h4 class="text-sm font-semibold mb-2">
                  {{ "subcategories" | i18n }}
                </h4>
                <ul class="list-disc pl-6">
                  <li
                    *ngFor="
                      let sub of subcategoriesOf(cat.id);
                      trackBy: trackBySubId
                    "
                    class="mb-1 flex items-center justify-between"
                  >
                    <span>{{ sub.name }}</span>
                    <div class="flex gap-2">
                      <button
                        type="button"
                        (click)="startEditSubcategory(sub)"
                        class="px-2 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 text-xs flex items-center gap-1"
                      >
                        <svg
                          xmlns="http://www.w3.org/2000/svg"
                          class="h-3 w-3"
                          fill="none"
                          viewBox="0 0 24 24"
                          stroke="currentColor"
                        >
                          <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5"
                          />
                        </svg>
                        {{ "edit" | i18n }}
                      </button>
                      <button
                        type="button"
                        (click)="requestDeleteSubcategory(sub)"
                        class="px-2 py-1 bg-red-500 text-white rounded hover:bg-red-600 text-xs flex items-center gap-1"
                      >
                        <svg
                          xmlns="http://www.w3.org/2000/svg"
                          class="h-3 w-3"
                          fill="none"
                          viewBox="0 0 24 24"
                          stroke="currentColor"
                        >
                          <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7"
                          />
                        </svg>
                        {{ "delete" | i18n }}
                      </button>
                    </div>
                  </li>
                  <li
                    *ngIf="(subcategoriesOf(cat.id) || []).length === 0"
                    class="text-sm text-gray-500"
                  >
                    {{ "noSubcategories" | i18n }}
                  </li>
                </ul>
              </div>
            </td>
          </tr>
        </ng-container>
      </tbody>
    </table>
  </div>

  <!-- Modais (fora da tabela) -->

  <!-- Modal inclusão categoria -->
  <div
    *ngIf="showAddCategoryModal()"
    class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
  >
    <div
      class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4 p-6"
      (click)="$event.stopPropagation()"
    >
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-bold">{{ "addNewCategory" | i18n }}</h2>
        <button
          type="button"
          (click)="closeAddCategoryModal()"
          class="text-gray-400 hover:text-gray-600"
        >
          ✕
        </button>
      </div>
      <div class="mb-4">
        <input
          type="text"
          [value]="newCategory()"
          (input)="newCategory.set($event.target.value)"
          placeholder="Nome da categoria"
          class="w-full p-2 border rounded-md"
          (keydown.enter)="addCategory()"
        />
      </div>
      <div class="flex justify-end gap-2">
        <button
          type="button"
          (click)="addCategory()"
          class="px-4 py-2 bg-indigo-600 text-white rounded-md"
        >
          {{ "add" | i18n }}
        </button>
        <button
          type="button"
          (click)="closeAddCategoryModal()"
          class="px-4 py-2 bg-gray-300 rounded-md"
        >
          {{ "cancel" | i18n }}
        </button>
      </div>
    </div>
  </div>

  <!-- Modal edição categoria (reaproveita editingCategory signal) -->
  <div
    *ngIf="editingCategory()"
    class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
  >
    <div
      class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4 p-6"
      (click)="$event.stopPropagation()"
    >
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-bold">{{ "editCategory" | i18n }}</h2>
        <button
          type="button"
          (click)="editingCategory.set(null)"
          class="text-gray-400 hover:text-gray-600"
        >
          ✕
        </button>
      </div>
      <div class="mb-4">
        <input
          type="text"
          [value]="editingCategoryName()"
          (input)="editingCategoryName.set($event.target.value)"
          class="w-full p-2 border rounded-md"
          (keydown.enter)="saveCategoryEdit()"
        />
      </div>
      <div class="flex justify-end gap-2">
        <button
          type="button"
          (click)="saveCategoryEdit()"
          class="px-4 py-2 bg-blue-600 text-white rounded-md"
        >
          {{ "save" | i18n }}
        </button>
        <button
          type="button"
          (click)="editingCategory.set(null)"
          class="px-4 py-2 bg-gray-300 rounded-md"
        >
          {{ "cancel" | i18n }}
        </button>
      </div>
    </div>
  </div>

  <!-- Modal detalhes categoria -->
  <div
    *ngIf="selectedCategoryForDetails()"
    class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
  >
    <div
      class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4 p-6"
      (click)="$event.stopPropagation()"
    >
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-bold">{{ "categoryDetails" | i18n }}</h2>
        <button
          type="button"
          (click)="selectedCategoryForDetails.set(null)"
          class="text-gray-400 hover:text-gray-600"
        >
          ✕
        </button>
      </div>
      <div class="mb-4">
        <p class="font-semibold">Nome</p>
        <p>{{ selectedCategoryForDetails()?.name }}</p>
        <p class="mt-2 font-semibold">Total de Subcategorias</p>
        <p>
          {{
            subcategoryCounts().get(selectedCategoryForDetails()?.id || 0) || 0
          }}
        </p>
      </div>
      <div class="flex justify-end">
        <button
          type="button"
          (click)="selectedCategoryForDetails.set(null)"
          class="px-4 py-2 bg-gray-300 rounded-md"
        >
          {{ "close" | i18n }}
        </button>
      </div>
    </div>
  </div>

  <!-- Modal gerenciamento de subcategorias (reaproveita selectedCategoryForSubcategories) -->
  <div
    *ngIf="selectedCategoryForSubcategories()"
    class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
  >
    <div
      class="bg-white rounded-lg shadow-xl max-w-lg w-full mx-4 p-6"
      (click)="$event.stopPropagation()"
    >
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-bold">
          {{
            "subcategoriesOf"
              | i18n
                : { category: selectedCategoryForSubcategories()?.name || "" }
          }}
        </h2>
        <button
          type="button"
          (click)="selectedCategoryForSubcategories.set(null)"
          class="text-gray-400 hover:text-gray-600"
        >
          ✕
        </button>
      </div>
      <div class="mb-4">
        <input
          type="text"
          [value]="newSubcategoryName()"
          (input)="newSubcategoryName.set($event.target.value)"
          placeholder="Nome da subcategoria"
          class="w-full p-2 border rounded-md"
          (keydown.enter)="addSubcategoryToCategory()"
        />
        <div class="grid grid-cols-1 md:grid-cols-2 gap-2 mt-2">
          <select
            [value]="newSubcategoryType()"
            (change)="newSubcategoryType.set($event.target.value)"
            class="p-2 border rounded-md"
          >
            <option value="">{{ "selectOption" | i18n }}</option>
            <option value="precificado">{{ "priced" | i18n }}</option>
            <option value="orçado">{{ "quoted" | i18n }}</option>
          </select>
          <input
            type="number"
            [value]="newSubcategoryAverageTime()"
            (input)="
              newSubcategoryAverageTime.set($event.target.valueAsNumber || null)
            "
            placeholder="Tempo médio (min)"
            class="p-2 border rounded-md"
            min="0"
          />
          <input
            type="number"
            [value]="newSubcategoryPrice()"
            (input)="
              newSubcategoryPrice.set($event.target.valueAsNumber || null)
            "
            placeholder="Preço (€)"
            class="p-2 border rounded-md"
            step="0.01"
            min="0"
          />
          <textarea
            [value]="newSubcategoryDescription()"
            (input)="newSubcategoryDescription.set($event.target.value)"
            placeholder="Descrição (opcional)"
            class="p-2 border rounded-md w-full"
          ></textarea>
        </div>
        <div class="flex justify-end gap-2 mt-2">
          <button
            type="button"
            (click)="addSubcategoryToCategory()"
            class="px-4 py-2 bg-green-600 text-white rounded-md"
          >
            {{ "addSubcategory" | i18n }}
          </button>
          <button
            type="button"
            (click)="selectedCategoryForSubcategories.set(null)"
            class="px-4 py-2 bg-gray-300 rounded-md"
          >
            {{ "cancel" | i18n }}
          </button>
        </div>
      </div>
      <ul class="list-disc pl-6">
        <li
          *ngFor="
            let sub of subcategoriesForSelectedCategory();
            trackBy: trackBySubId
          "
          class="flex items-center justify-between mb-2"
        >
          <span>{{ sub.name }}</span>
          <div class="flex gap-2">
            <button
              type="button"
              (click)="startEditSubcategory(sub)"
              class="px-2 py-1 bg-blue-500 text-white rounded text-xs"
            >
              {{ "edit" | i18n }}
            </button>
            <button
              type="button"
              (click)="requestDeleteSubcategory(sub)"
              class="px-2 py-1 bg-red-500 text-white rounded text-xs"
            >
              {{ "delete" | i18n }}
            </button>
          </div>
        </li>
      </ul>
    </div>
  </div>

  <!-- Modal de confirmação de exclusão de subcategoria -->
  <!-- Modal de edição de subcategoria -->
  <div
    *ngIf="editingSubcategory()"
    class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
  >
    <div
      class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4 p-6"
      (click)="$event.stopPropagation()"
    >
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-bold">{{ "editSubcategory" | i18n }}</h2>
        <button
          type="button"
          (click)="editingSubcategory.set(null)"
          class="text-gray-400 hover:text-gray-600"
        >
          ✕
        </button>
      </div>
      <div class="mb-4 grid grid-cols-1 gap-2">
        <input
          type="text"
          [value]="editingSubcategoryName()"
          (input)="editingSubcategoryName.set($event.target.value)"
          class="w-full p-2 border rounded-md"
        />
        <select
          [value]="editingSubcategoryType()"
          (change)="editingSubcategoryType.set($event.target.value)"
          class="p-2 border rounded-md"
        >
          <option value="">{{ "selectOption" | i18n }}</option>
          <option value="precificado">{{ "priced" | i18n }}</option>
          <option value="orçado">{{ "quoted" | i18n }}</option>
        </select>
        <input
          type="number"
          [value]="editingSubcategoryAverageTime()"
          (input)="
            editingSubcategoryAverageTime.set(
              $event.target.valueAsNumber || null
            )
          "
          placeholder="Tempo médio (min)"
          class="p-2 border rounded-md"
          min="0"
        />
        <input
          type="number"
          [value]="editingSubcategoryPrice()"
          (input)="
            editingSubcategoryPrice.set($event.target.valueAsNumber || null)
          "
          placeholder="Preço (€)"
          class="p-2 border rounded-md"
          step="0.01"
          min="0"
        />
        <textarea
          [value]="editingSubcategoryDescription()"
          (input)="editingSubcategoryDescription.set($event.target.value)"
          placeholder="Descrição (opcional)"
          class="p-2 border rounded-md w-full"
        ></textarea>
      </div>
      <div class="flex justify-end gap-2">
        <button
          type="button"
          (click)="saveSubcategoryEdit()"
          class="px-4 py-2 bg-blue-600 text-white rounded-md"
        >
          {{ "save" | i18n }}
        </button>
        <button
          type="button"
          (click)="editingSubcategory.set(null)"
          class="px-4 py-2 bg-gray-300 rounded-md"
        >
          {{ "cancel" | i18n }}
        </button>
      </div>
    </div>
  </div>
  <div
    *ngIf="showDeleteSubcategoryModal() && subcategoryToDelete()"
    class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
  >
    <div
      class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4 p-6"
      (click)="$event.stopPropagation()"
    >
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-bold">Excluir Subcategoria</h2>
        <button
          type="button"
          (click)="cancelDeleteSubcategory()"
          class="text-gray-400 hover:text-gray-600"
        >
          ✕
        </button>
      </div>
      <p>Confirma exclusão de: {{ subcategoryToDelete()?.name }}</p>
      <div class="flex justify-end gap-2 mt-4">
        <button
          type="button"
          (click)="confirmDeleteSubcategory()"
          class="px-4 py-2 bg-red-600 text-white rounded-md"
        >
          Excluir
        </button>
        <button
          type="button"
          (click)="cancelDeleteSubcategory()"
          class="px-4 py-2 bg-gray-300 rounded-md"
        >
          Cancelar
        </button>
      </div>
    </div>
  </div>

  <!-- Modal de confirmação de exclusão de categoria -->
  <div
    *ngIf="showDeleteModal() && categoryToDelete()"
    class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
  >
    <div
      class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4 p-6"
      (click)="$event.stopPropagation()"
    >
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-bold">Excluir Categoria</h2>
        <button
          type="button"
          (click)="cancelDeleteCategory()"
          class="text-gray-400 hover:text-gray-600"
        >
          ✕
        </button>
      </div>
      <p>Confirma exclusão de: {{ categoryToDelete()?.name }}</p>
      <div class="flex justify-end gap-2 mt-4">
        <button
          type="button"
          (click)="confirmDeleteCategory()"
          class="px-4 py-2 bg-red-600 text-white rounded-md"
        >
          Excluir
        </button>
        <button
          type="button"
          (click)="cancelDeleteCategory()"
          class="px-4 py-2 bg-gray-300 rounded-md"
        >
          Cancelar
        </button>
      </div>
    </div>
  </div>
</div>
