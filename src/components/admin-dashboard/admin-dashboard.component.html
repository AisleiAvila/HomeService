<div class="space-y-6">
    <!-- Header & Navigation -->
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center">
        <h1 class="text-3xl font-bold text-gray-800">{{ 'adminPanel' | i18n }}</h1>
        <div class="mt-4 sm:mt-0 flex flex-wrap gap-1 bg-gray-200 p-1 rounded-lg">
            @for (view of views(); track view.id) {
                <button 
                    (click)="setView(view.id)"
                    class="px-3 py-2 text-sm font-medium rounded-md transition-colors flex items-center relative"
                    [class.bg-white]="currentView() === view.id"
                    [class.text-gray-800]="currentView() === view.id"
                    [class.text-gray-500]="currentView() !== view.id"
                    [class.hover:bg-white]="currentView() !== view.id">
                    <i [class]="view.icon" class="mr-2"></i>
                    <span>{{ view.label }}</span>
                    @if(view.id === 'approvals' && pendingApprovalCount() > 0) {
                      <span class="absolute -top-1 -right-1 h-5 w-5 bg-orange-500 text-white text-xs rounded-full flex items-center justify-center border-2 border-gray-200">
                        {{ pendingApprovalCount() }}
                      </span>
                    }
                </button>
            }
        </div>
    </div>

    <!-- Content Area -->
    @switch (currentView()) {
        @case ('overview') {
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                @for (stat of stats(); track stat.label) {
                    <div class="bg-white p-6 rounded-lg shadow-md flex items-center space-x-4">
                        <div class="w-12 h-12 flex items-center justify-center rounded-full" [class]="stat.bgColor">
                            <i class="text-2xl" [class]="stat.icon"></i>
                        </div>
                        <div>
                            <h3 class="text-gray-500 text-sm font-medium">{{ stat.label }}</h3>
                            <p class="text-3xl font-bold text-gray-800 mt-1">{{ stat.value }}</p>
                        </div>
                    </div>
                }
            </div>
        }
        @case ('requests') {
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-xl font-semibold mb-4">{{ 'pendingActions' | i18n }}</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">{{ 'request' | i18n }}</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">{{ 'client' | i18n }}</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">{{ 'status' | i18n }}</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">{{ 'action' | i18n }}</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            @if (actionableRequests().length === 0) {
                                <tr><td colspan="4" class="px-6 py-4 text-center text-gray-500">{{ 'noRequestsNeedAttention' | i18n }}</td></tr>
                            } @else {
                                @for (request of actionableRequests(); track request.id) {
                                    <tr class="hover:bg-gray-50">
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <div class="text-sm font-medium text-gray-900">{{ request.title }}</div>
                                            <div class="text-sm text-gray-500">{{ request.category }}</div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ getClientName(request.clientId) }}</td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <span [class]="statusClass(request.status)">{{ request.status }}</span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                            @if (request.status === 'Pending' || request.status === 'Quoted') {
                                                <button (click)="selectRequestForQuote(request)" class="text-indigo-600 hover:text-indigo-900">
                                                  {{ request.status === 'Quoted' ? ('viewQuote' | i18n) : ('provideQuote' | i18n) }}
                                                </button>
                                            }
                                            @if (request.status === 'Approved') {
                                                <button (click)="selectRequestForAssignment(request)" class="text-green-600 hover:text-green-900">{{ 'assign' | i18n }}</button>
                                            }
                                        </td>
                                    </tr>
                                }
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        }
        @case ('approvals') {
           <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-xl font-semibold mb-4">{{ 'pendingRegistrations' | i18n }}</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">{{ 'name' | i18n }}</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">{{ 'email' | i18n }}</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">{{ 'phone' | i18n }}</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">{{ 'actions' | i18n }}</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            @if (pendingRegistrations().length === 0) {
                                <tr><td colspan="4" class="px-6 py-4 text-center text-gray-500">{{ 'noPendingRegistrations' | i18n }}</td></tr>
                            } @else {
                                @for (user of pendingRegistrations(); track user.id) {
                                    <tr class="hover:bg-gray-50">
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ user.name }}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ user.email }}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ user.phone }}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-4">
                                            <button (click)="approveClient(user.id)" class="text-green-600 hover:text-green-900">{{ 'approve' | i18n }}</button>
                                            <button (click)="rejectClient(user.id)" class="text-red-600 hover:text-red-900">{{ 'reject' | i18n }}</button>
                                        </td>
                                    </tr>
                                }
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        }
        @case ('finances') {
             <div class="space-y-6">
                <!-- Financial Stats -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div class="bg-white p-4 rounded-lg shadow"><h4 class="text-sm text-gray-500">{{ 'completedServices' | i18n }}</h4><p class="text-2xl font-bold">{{ financialStats().completedServices }}</p></div>
                    <div class="bg-white p-4 rounded-lg shadow"><h4 class="text-sm text-gray-500">{{ 'totalRevenue' | i18n }}</h4><p class="text-2xl font-bold text-green-600">{{ formatCost(financialStats().totalRevenue) }}</p></div>
                    <div class="bg-white p-4 rounded-lg shadow"><h4 class="text-sm text-gray-500">{{ 'totalTax' | i18n }} (7%)</h4><p class="text-2xl font-bold text-blue-600">{{ formatCost(financialStats().totalTax) }}</p></div>
                    <div class="bg-white p-4 rounded-lg shadow"><h4 class="text-sm text-gray-500">{{ 'outstandingAmount' | i18n }}</h4><p class="text-2xl font-bold text-red-600">{{ formatCost(financialStats().outstandingAmount) }}</p></div>
                </div>
                <!-- Financial Details Table -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <div class="flex justify-between items-center mb-4">
                      <h2 class="text-xl font-semibold">{{ 'financialDetails' | i18n }}</h2>
                      <button (click)="exportToCSV()" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700 flex items-center gap-2">
                        <i class="fas fa-file-csv"></i> {{ 'exportToCsv' | i18n }}
                      </button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                           <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">{{ 'csvId' | i18n }}</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">{{ 'csvClient' | i18n }}</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">{{ 'csvProfessional' | i18n }}</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">{{ 'csvService' | i18n }}</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">{{ 'csvBaseValue' | i18n }}</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">{{ 'csvTax' | i18n }} (7%)</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">{{ 'csvTotalValue' | i18n }}</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">{{ 'csvPaymentStatus' | i18n }}</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">{{ 'actions' | i18n }}</th>
                                </tr>
                            </thead>
                            <tbody>
                                @for(req of completedRequests(); track req.id){
                                <tr class="hover:bg-gray-50">
                                    <td class="px-4 py-2 text-sm">{{ req.id }}</td>
                                    <td class="px-4 py-2 text-sm">{{ getClientName(req.clientId) }}</td>
                                    <td class="px-4 py-2 text-sm">{{ getProfessionalName(req.professionalId) }}</td>
                                    <td class="px-4 py-2 text-sm font-semibold">{{ req.title }}</td>
                                    <td class="px-4 py-2 text-sm">{{ formatCost(req.cost) }}</td>
                                    <td class="px-4 py-2 text-sm">{{ formatCost(req.cost ? req.cost * 0.07 : 0) }}</td>
                                    <td class="px-4 py-2 text-sm font-bold">{{ formatCost(req.cost ? req.cost * 1.07 : 0) }}</td>
                                    <td class="px-4 py-2 text-sm"><span [class.text-green-600]="req.paymentStatus === 'Paid'" [class.text-red-600]="req.paymentStatus !== 'Paid'">{{ req.paymentStatus === 'Paid' ? ('paid' | i18n) : ('unpaid' | i18n) }}</span></td>
                                    <td class="px-4 py-2 text-sm"><button (click)="generateInvoice(req)" class="text-blue-600 hover:underline">{{ 'generateInvoice' | i18n }}</button></td>
                                </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
             </div>
        }
        @case ('professionals') {
            <div class="bg-white p-6 rounded-lg shadow-md">
                <div class="flex justify-between items-center mb-4">
                  <h2 class="text-xl font-semibold">{{ 'manageProfessionals' | i18n }}</h2>
                  <button (click)="showAddProfessionalForm.set(true)" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700 flex items-center gap-2">
                    <i class="fas fa-plus"></i> {{ 'addProfessional' | i18n }}
                  </button>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">{{ 'professional' | i18n }}</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">{{ 'specialties' | i18n }}</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">{{ 'actions' | i18n }}</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                           @for (pro of professionals(); track pro.id) {
                            <tr class="hover:bg-gray-50">
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="flex items-center">
                                        <img [src]="pro.avatarUrl" class="h-10 w-10 rounded-full mr-4">
                                        <div>
                                            <div class="text-sm font-medium text-gray-900">{{ pro.name }}</div>
                                            <div class="text-sm text-gray-500">{{ pro.email }}</div>
                                        </div>
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                  {{ (pro.specialties || []).join(', ') }}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                  <button (click)="startEditProfessional(pro)" class="text-indigo-600 hover:text-indigo-900">{{ 'edit' | i18n }}</button>
                                </td>
                            </tr>
                           }
                        </tbody>
                    </table>
                </div>
            </div>
        }
        @case ('categories') {
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <!-- Add Category -->
              <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-xl font-semibold mb-4">{{ 'addNewCategory' | i18n }}</h2>
                <form #addCatForm="ngForm" (ngSubmit)="addCategory()">
                  <label for="newCategory" class="block text-sm font-medium text-gray-700">{{ 'categoryName' | i18n }}</label>
                  <input type="text" id="newCategory" name="newCategory" [(ngModel)]="newCategory" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                  <button type="submit" [disabled]="addCatForm.invalid" class="mt-4 px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700 disabled:bg-blue-300">{{ 'add' | i18n }}</button>
                </form>
              </div>
              <!-- Category List -->
              <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-xl font-semibold mb-4">{{ 'serviceCategories' | i18n }}</h2>
                <ul class="divide-y divide-gray-200">
                  @for (cat of allCategories(); track cat) {
                    <li class="py-3 flex justify-between items-center">
                      @if (editingCategory() === cat) {
                        <input type="text" [(ngModel)]="editingCategoryName" class="flex-grow rounded-md border-gray-300 shadow-sm">
                        <div class="flex items-center space-x-2 ml-4">
                           <button (click)="saveCategoryEdit()" class="text-green-600 hover:text-green-800"><i class="fas fa-check"></i></button>
                           <button (click)="editingCategory.set(null)" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times"></i></button>
                        </div>
                      } @else {
                        <span class="text-sm font-medium text-gray-800">{{ cat }}</span>
                        <div class="flex items-center space-x-4">
                          <button (click)="startEditCategory(cat)" class="text-blue-600 hover:text-blue-800"><i class="fas fa-pencil-alt"></i></button>
                          <button (click)="deleteCategory(cat)" class="text-red-600 hover:text-red-800"><i class="fas fa-trash-alt"></i></button>
                        </div>
                      }
                    </li>
                  }
                </ul>
              </div>
            </div>
        }
    }
</div>

<!-- MODALS -->

<!-- Quote Modal -->
@if (quoteRequest(); as request) {
  <div class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl p-6 max-w-lg w-full">
      <h3 class="text-xl font-bold mb-4">{{ 'quoteFor' | i18n }}: {{ request.title }}</h3>
      <p class="text-sm text-gray-600 mb-4">{{ request.description }}</p>
      <label class="block text-sm font-medium text-gray-700">{{ 'quoteValue' | i18n }} ({{ 'currency' | i18n }})</label>
      <input type="number" [(ngModel)]="quoteAmount" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
      <div class="mt-6 flex justify-between">
        <div>
           @if (request.status === 'Quoted') {
            <button (click)="respondToQuote(request.id, false)" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 mr-2">{{ 'reject' | i18n }}</button>
            <button (click)="respondToQuote(request.id, true)" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">{{ 'approve' | i18n }}</button>
           }
        </div>
        <div>
           <button (click)="quoteRequest.set(null)" class="px-4 py-2 bg-gray-200 rounded-md">{{ 'cancel' | i18n }}</button>
           <button (click)="submitQuote()" class="px-4 py-2 bg-blue-600 text-white rounded-md ml-2">{{ 'submit' | i18n }}</button>
        </div>
      </div>
    </div>
  </div>
}

<!-- Assign Professional Modal -->
@if (assignmentRequest(); as request) {
   <div class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl p-6 max-w-lg w-full">
      <h3 class="text-xl font-bold mb-4">{{ 'assignProfessional' | i18n }}</h3>
      <p class="text-sm mb-4">{{ 'selectProfessionalFor' | i18n }}: <strong>{{ request.title }}</strong></p>
      <select [(ngModel)]="assigningProfessionalId" class="block w-full rounded-md border-gray-300 shadow-sm">
        <option [ngValue]="null" disabled>{{ 'selectAProfessional' | i18n }}</option>
        @for (pro of getProfessionalsForRequest(request.category); track pro.id) {
          <option [value]="pro.id">{{ pro.name }}</option>
        }
      </select>
       <div class="mt-6 flex justify-end space-x-2">
         <button (click)="assignmentRequest.set(null)" class="px-4 py-2 bg-gray-200 rounded-md">{{ 'cancel' | i18n }}</button>
         <button (click)="assignProfessional()" class="px-4 py-2 bg-blue-600 text-white rounded-md">{{ 'assign' | i18n }}</button>
      </div>
    </div>
  </div>
}

<!-- Add/Edit Professional Modal -->
@if (showAddProfessionalForm() || editingProfessional()) {
  <div class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl p-6 max-w-lg w-full">
      <h3 class="text-xl font-bold mb-4">{{ editingProfessional() ? ('editProfessional' | i18n) : ('addNewProfessional' | i18n) }}</h3>
      <div class="space-y-4">
        <div>
            <label class="block text-sm font-medium">{{ 'name' | i18n }}</label>
            <input type="text" [ngModel]="editingProfessional() ? editingProfessionalName() : newProfessionalName()" (ngModelChange)="editingProfessional() ? editingProfessionalName.set($event) : newProfessionalName.set($event)" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
        </div>
        <div>
            <label class="block text-sm font-medium">{{ 'email' | i18n }}</label>
            <input type="email" [ngModel]="editingProfessional() ? editingProfessionalEmail() : newProfessionalEmail()" (ngModelChange)="editingProfessional() ? editingProfessionalEmail.set($event) : newProfessionalEmail.set($event)" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
        </div>
        <div>
            <label class="block text-sm font-medium">{{ 'specialties' | i18n }}</label>
            <div class="mt-2 grid grid-cols-2 gap-2">
                @for(cat of allCategories(); track cat) {
                    <label class="flex items-center">
                        <input type="checkbox"
                               [checked]="editingProfessional() ? editingProfessionalSpecialties().includes(cat) : newProfessionalSpecialties().includes(cat)"
                               (change)="editingProfessional() ? toggleEditProfessionalSpecialty(cat, $event) : toggleNewProfessionalSpecialty(cat, $event)"
                               class="h-4 w-4 rounded border-gray-300">
                        <span class="ml-2 text-sm">{{ cat }}</span>
                    </label>
                }
            </div>
        </div>
      </div>
      <div class="mt-6 flex justify-end space-x-2">
         <button (click)="editingProfessional() ? cancelEditProfessional() : resetNewProfessionalForm()" class="px-4 py-2 bg-gray-200 rounded-md">{{ 'cancel' | i18n }}</button>
         <button (click)="editingProfessional() ? saveProfessionalEdit() : addProfessional()" class="px-4 py-2 bg-blue-600 text-white rounded-md">{{ editingProfessional() ? ('saveChanges' | i18n) : ('addProfessional' | i18n) }}</button>
      </div>
    </div>
  </div>
}

<!-- Invoice Modal -->
@if(invoiceRequest(); as request) {
  <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 no-print">
    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full">
      <div #invoiceContent class="p-8 invoice-content">
        <div class="flex justify-between items-center border-b pb-4 mb-6">
            <h1 class="text-3xl font-bold">{{ 'invoice' | i18n }}</h1>
            <div class="text-right">
                <h2 class="text-xl font-semibold">FixItNow Inc.</h2>
                <p class="text-sm text-gray-500">123 Service Lane, Springfield</p>
            </div>
        </div>
        <div class="grid grid-cols-2 gap-8 mb-8">
            <div>
                <h3 class="text-sm font-semibold text-gray-500 uppercase">{{ 'billedTo' | i18n }}</h3>
                <p class="font-bold">{{ getClientName(request.clientId) }}</p>
                <p>{{ request.address.street }}, {{ request.address.city }}</p>
            </div>
             <div>
                <h3 class="text-sm font-semibold text-gray-500 uppercase">{{ 'serviceProvidedBy' | i18n }}</h3>
                <p class="font-bold">{{ getProfessionalName(request.professionalId) }}</p>
            </div>
        </div>
        <table class="w-full mb-8">
            <thead>
                <tr class="bg-gray-100">
                    <th class="p-2 text-left font-semibold">{{ 'serviceDescription' | i18n }}</th>
                    <th class="p-2 text-right font-semibold">{{ 'total' | i18n }}</th>
                </tr>
            </thead>
            <tbody>
                <tr class="border-b">
                    <td class="p-2">{{ request.title }}</td>
                    <td class="p-2 text-right">{{ formatCost(request.cost) }}</td>
                </tr>
            </tbody>
            <tfoot>
                <tr>
                    <td class="p-2 text-right font-semibold">{{ 'subtotal' | i18n }}:</td>
                    <td class="p-2 text-right">{{ formatCost(request.cost) }}</td>
                </tr>
                <tr>
                    <td class="p-2 text-right font-semibold">{{ 'tax' | i18n }} (7%):</td>
                    <td class="p-2 text-right">{{ formatCost(request.cost ? request.cost * 0.07 : 0) }}</td>
                </tr>
                 <tr class="bg-gray-100">
                    <td class="p-2 text-right font-bold text-xl">{{ 'grandTotal' | i18n }}:</td>
                    <td class="p-2 text-right font-bold text-xl">{{ formatCost(request.cost ? request.cost * 1.07 : 0) }}</td>
                </tr>
            </tfoot>
        </table>
        <div class="text-center text-sm text-gray-500">{{ 'thankYou' | i18n }}</div>
      </div>
      <div class="p-4 bg-gray-50 flex justify-end space-x-2 no-print">
          <button (click)="invoiceRequest.set(null)" class="px-4 py-2 bg-gray-200 rounded-md">{{ 'close' | i18n }}</button>
          <button (click)="printInvoice()" class="px-4 py-2 bg-blue-600 text-white rounded-md">{{ 'print' | i18n }}</button>
      </div>
    </div>
  </div>
}