<!-- Logged-in View -->
@if (isLoggedIn() && currentUser(); as user) {
  <div class="flex h-screen bg-gray-100 font-sans">
    <!-- Sidebar -->
    <aside class="w-64 bg-gray-800 text-white flex flex-col no-print">
      <div class="h-16 flex items-center justify-center text-2xl font-bold border-b border-gray-700">
        <i class="fas fa-tools mr-3"></i>
        <span>FixItNow</span>
      </div>
      <nav class="flex-1 px-4 py-6 space-y-2">
        @for (view of availableViews(); track view.id) {
          <a href="#" (click)="setView(view.id); $event.preventDefault()"
             class="flex items-center px-4 py-2 rounded-md transition-colors"
             [class.bg-gray-700]="currentView() === view.id"
             [class.hover:bg-gray-700]="currentView() !== view.id">
            <i class="w-6 text-center" [class]="view.icon"></i>
            <span class="ml-3">{{ view.label }}</span>
          </a>
        }
      </nav>
      <div class="px-4 py-4 border-t border-gray-700">
        <a href="#" (click)="setView('profile'); $event.preventDefault()"
           class="flex items-center px-4 py-2 rounded-md transition-colors"
           [class.bg-gray-700]="currentView() === 'profile'"
           [class.hover:bg-gray-700]="currentView() !== 'profile'">
          <i class="w-6 text-center fas fa-user-cog"></i>
          <span class="ml-3">My Profile</span>
        </a>
         <a href="#" (click)="logout(); $event.preventDefault()"
           class="flex items-center px-4 py-2 mt-2 rounded-md text-red-400 hover:bg-red-500 hover:text-white transition-colors">
          <i class="w-6 text-center fas fa-sign-out-alt"></i>
          <span class="ml-3">Logout</span>
        </a>
      </div>
    </aside>

    <!-- Main Content -->
    <div class="flex-1 flex flex-col overflow-hidden">
      <!-- Header -->
      <header class="h-16 bg-white border-b border-gray-200 flex items-center justify-between px-6 no-print">
        <div>
          <h1 class="text-xl font-semibold text-gray-700">{{ currentViewLabel() }}</h1>
        </div>
        <div class="flex items-center space-x-4">
           <div class="flex items-center space-x-2">
            <img [src]="user.avatarUrl" [alt]="user.name" class="h-9 w-9 rounded-full">
            <div>
              <div class="font-semibold text-gray-800 text-sm">{{ user.name }}</div>
              <div class="text-xs text-gray-500 capitalize">{{ user.role }}</div>
            </div>
           </div>
          
          <!-- Notification Bell -->
          <div class="relative">
            <button (click)="showNotifications.set(!showNotifications())" class="relative p-2 rounded-full text-gray-500 hover:bg-gray-100 hover:text-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
              <i class="fas fa-bell"></i>
              @if (unreadNotificationsCount() > 0) {
                <span class="absolute top-0 right-0 h-4 w-4 bg-red-500 text-white text-xs rounded-full flex items-center justify-center">
                  {{ unreadNotificationsCount() }}
                </span>
              }
            </button>
            @if (showNotifications()) {
              <app-notification-center (close)="showNotifications.set(false)"></app-notification-center>
            }
          </div>
        </div>
      </header>
      
      <!-- Page Content -->
      <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100 p-6">
        @switch (currentView()) {
          @case ('dashboard') { <app-dashboard [user]="user" (viewDetails)="handleViewDetails($event)" (openChat)="handleOpenChat($event)" (payNow)="handlePayNow($event)"/> }
          @case ('admin') { <app-admin-dashboard /> }
          @case ('new_request') { <app-service-request-form [client]="user" (requestSubmitted)="setView('dashboard')" /> }
          @case ('schedule') { <app-schedule [user]="user" (viewDetails)="handleViewDetails($event)" /> }
          @case ('search') { <app-search [user]="user" /> }
          @case ('profile') { <app-profile [user]="user" /> }
        }
      </main>
    </div>
  </div>
} @else {
  <!-- Logged-out / Registration View -->
  <div class="w-full h-screen flex items-center justify-center bg-gray-200">
    @if (currentView() === 'register') {
      <app-register (registrationComplete)="handleRegistrationComplete()" (cancel)="setView('dashboard')" />
    } @else {
       <div class="max-w-sm w-full bg-white p-8 rounded-xl shadow-lg text-center">
        <div class="flex justify-center mb-4">
            <i class="fas fa-tools text-5xl text-blue-600"></i>
        </div>
        <h1 class="text-3xl font-bold text-gray-800">Welcome to FixItNow</h1>
        <p class="text-gray-500 mt-2 mb-6">Please select a user to log in.</p>

        <select #loginSelect class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm mb-4">
          @for (user of allUsers(); track user.id) {
            <option [value]="user.id">{{ user.name }} ({{ user.role }})</option>
          }
        </select>
        <button (click)="loginAs(loginSelect.value)" class="w-full px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
          Login
        </button>

        <div class="mt-6 text-sm">
          <span class="text-gray-600">New client?</span>
          <button (click)="setView('register')" class="font-medium text-blue-600 hover:underline ml-1">
            Cadastre-se
          </button>
        </div>
      </div>
    }
  </div>
}

<!-- Modals (Global) -->
@if (isLoggedIn()) {
  @if (viewingRequest(); as request) {
    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" (click)="closeModals()">
      <div class="bg-white rounded-lg shadow-xl p-8 max-w-lg w-full" (click)="$event.stopPropagation()">
        <h3 class="text-2xl font-bold mb-4">{{ request.title }}</h3>
        <div class="space-y-3 text-gray-700">
          <p><strong class="w-28 inline-block">Category:</strong> {{ request.category }}</p>
          <p><strong class="w-28 inline-block">Status:</strong> <span [class]="statusClass(request.status)">{{ request.status }}</span></p>
          <p><strong class="w-28 inline-block">Address:</strong> {{ formatAddress(request.address) }}</p>
          <p><strong class="w-28 inline-block">Requested:</strong> {{ request.requestedDate | date:'longDate' }}</p>
          <p><strong class="w-28 inline-block">Scheduled:</strong> {{ request.scheduledDate ? (request.scheduledDate | date:'full') : 'Not scheduled' }}</p>
        </div>
        <div class="mt-6 text-right">
          <button (click)="closeModals()" class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700">Close</button>
        </div>
      </div>
    </div>
  }
  @if (chattingRequest(); as request) {
     <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" (click)="closeModals()">
        <div class="bg-white rounded-lg shadow-xl max-w-lg w-full h-[66.67%] flex flex-col" (click)="$event.stopPropagation()">
            <div class="p-4 border-b flex justify-between items-center">
                <h3 class="text-xl font-bold">Chat for: {{ request.title }}</h3>
                <button (click)="closeModals()" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            </div>
            <div class="flex-1 overflow-hidden">
                <app-chat [serviceRequest]="request" [currentUser]="currentUser()!"></app-chat>
            </div>
        </div>
    </div>
  }
  @if (requestForPayment(); as paymentReq) {
    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" (click)="closeModals()">
      <div class="bg-white rounded-lg shadow-xl p-8 max-w-md w-full" (click)="$event.stopPropagation()">
        <h3 class="text-2xl font-bold mb-2">Complete Payment</h3>
        <p class="text-gray-600 mb-6">For service: <span class="font-semibold">{{ paymentReq.title }}</span></p>
        <div class="my-4 p-4 bg-blue-50 border border-blue-200 rounded-lg text-center">
          <p class="text-sm text-blue-700">Amount Due</p>
          <p class="text-4xl font-bold text-blue-900">{{ formatCost(paymentReq.cost) }}</p>
        </div>
        <form #paymentForm="ngForm" (ngSubmit)="submitPayment()">
          <div class="space-y-4">
            <div>
              <label for="cardNumber" class="block text-sm font-medium text-gray-700">Card Number</label>
              <input type="text" id="cardNumber" name="cardNumber" ngModel required placeholder="0000 0000 0000 0000" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
            </div>
            <div class="flex space-x-4">
               <div class="flex-1">
                <label for="expiryDate" class="block text-sm font-medium text-gray-700">Expiry Date</label>
                <input type="text" id="expiryDate" name="expiryDate" ngModel required placeholder="MM/YY" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
              </div>
              <div class="flex-1">
                <label for="cvc" class="block text-sm font-medium text-gray-700">CVC</label>
                <input type="text" id="cvc" name="cvc" ngModel required placeholder="123" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
              </div>
            </div>
          </div>
           <div class="mt-8 flex justify-end space-x-3">
            <button type="button" (click)="closeModals()" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Cancel</button>
            <button type="submit" [disabled]="paymentForm.invalid" class="px-6 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 disabled:bg-green-300">Pay Now</button>
          </div>
        </form>
      </div>
    </div>
  }
}
